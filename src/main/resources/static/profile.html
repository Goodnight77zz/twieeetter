<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>
        <span class="cn">ç¼–è¾‘ä¸ªäººèµ„æ–™</span>
        <span class="en">Edit Profile</span>
    </title>
    <!-- å¼•å…¥é€šç”¨è¯­è¨€ç»„ä»¶CSS -->
    <link rel="stylesheet" href="common/lang-component.css">
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding-top: 80px;
            display: flex;
            justify-content: center;
        }
        .navbar {
            position: fixed; top: 0; width: 100%; background: white; height: 60px;
            display: flex; align-items: center; padding: 0 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); box-sizing: border-box; z-index: 1000;
        }
        .nav-link { color: #555; text-decoration: none; font-weight: bold; margin-right: 15px; display: flex; align-items: center; gap: 5px;}
        .nav-link:hover { color: #1da1f2; }

        /* å¡ç‰‡å®¹å™¨ */
        .card {
            background: white;
            padding: 40px;
            border-radius: 16px;
            width: 450px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .page-title { font-size: 22px; font-weight: 900; color: #333; margin-bottom: 30px; }

        /* === å¤´åƒäº¤äº’æ ¸å¿ƒæ ·å¼ === */
        .avatar-wrapper {
            position: relative;
            width: 120px;
            height: 120px;
            margin-bottom: 30px;
            cursor: pointer;
            group: hover; /* ç”¨äºè§¦å‘å­å…ƒç´  */
        }

        .avatar-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
            border: 4px solid white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        /* é¼ æ ‡æ‚¬åœæ—¶çš„æ•ˆæœï¼šå‘å…‰ + å˜æš—ä¸€ç‚¹ç‚¹ */
        .avatar-wrapper:hover .avatar-img {
            box-shadow: 0 0 20px rgba(29, 161, 242, 0.6); /* è“è‰²å‘å…‰ */
            transform: scale(1.02);
            filter: brightness(0.9);
        }

        /* æ‚¬åœæ—¶æ˜¾ç¤ºçš„æç¤ºå›¾æ ‡/æ–‡å­— (å¯é€‰) */
        .avatar-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: 0.3s;
            color: white;
            font-weight: bold;
            font-size: 14px;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }
        .avatar-wrapper:hover .avatar-overlay {
            opacity: 1;
        }

        /* è¡¨å•æ ·å¼ */
        .form-group { width: 100%; margin-bottom: 20px; text-align: left; }
        .label { font-size: 14px; color: #666; font-weight: bold; margin-bottom: 8px; display: block; }

        input, textarea {
            width: 100%; padding: 12px;
            border: 1px solid #ddd; border-radius: 8px;
            box-sizing: border-box; font-size: 15px; outline: none;
            transition: border 0.2s;
        }
        input:focus, textarea:focus { border-color: #1da1f2; }

        /* åªè¯»è¾“å…¥æ¡†æ ·å¼ */
        input.readonly-input {
            background-color: #f5f7f9;
            color: #8899a6;
            cursor: not-allowed;
            border-color: #eee;
        }

        .save-btn {
            background-color: #1da1f2; color: white;
            border: none; padding: 12px 50px;
            border-radius: 30px; cursor: pointer;
            font-weight: bold; font-size: 16px;
            transition: background 0.2s;
            margin-top: 10px;
            box-shadow: 0 4px 10px rgba(29, 161, 242, 0.3);
        }
        .save-btn:hover { background-color: #0d8ddb; }
    </style>
</head>
<body>
<div class="navbar">
    <a href="index.html" class="nav-link">â¬…
        <span class="cn">è¿”å›å¹¿åœº</span>
        <span class="en">Back to Plaza</span>
    </a>
</div>

<div class="card">
    <div class="page-title">
        <span class="cn">ç¼–è¾‘ä¸ªäººèµ„æ–™</span>
        <span class="en">Edit Profile</span>
    </div>

    <!-- å¤´åƒåŒºåŸŸï¼šç‚¹å‡»è§¦å‘ fileInput -->
    <div class="avatar-wrapper" onclick="document.getElementById('avatarInput').click()">
        <img id="avatarPreview" class="avatar-img" src="https://via.placeholder.com/120" alt="Avatar">
        <!-- æ‚¬åœæç¤º -->
        <div class="avatar-overlay">
            <span class="cn">ğŸ“· æ›´æ¢å¤´åƒ</span>
            <span class="en">ğŸ“· Change Avatar</span>
        </div>
    </div>
    <!-- éšè—çš„æ–‡ä»¶è¾“å…¥æ¡† -->
    <input type="file" id="avatarInput" accept="image/*" style="display: none;" onchange="previewImage(this)">

    <div class="form-group">
        <label class="label">
            <span class="cn">è´¦å· (ä¸å¯ä¿®æ”¹)</span>
            <span class="en">Account (Unmodifiable)</span>
        </label>
        <!-- readonly å±æ€§ç¦æ­¢ä¿®æ”¹ï¼Œç‰¹å®šæ ·å¼å˜ç° -->
        <input type="text" id="usernameInput" class="readonly-input" readonly>
    </div>

    <div class="form-group">
        <label class="label">
            <span class="cn">æ˜µç§°</span>
            <span class="en">Nickname</span>
        </label>
        <input type="text" id="nicknameInput" placeholder="ç»™è‡ªå·±èµ·ä¸ªå¥½å¬çš„åå­—" data-placeholder-en="Choose a nice nickname">
    </div>

    <div class="form-group">
        <label class="label">
            <span class="cn">ä¸ªäººç®€ä»‹</span>
            <span class="en">Bio</span>
        </label>
        <textarea id="bioInput" rows="4" placeholder="ä»‹ç»ä¸€ä¸‹ä½ çš„ç ”ç©¶æ–¹å‘..." data-placeholder-en="Introduce your research direction..."></textarea>
    </div>

    <button class="save-btn" onclick="saveProfile()">
        <span class="cn">ä¿å­˜ä¿®æ”¹</span>
        <span class="en">Save Changes</span>
    </button>
</div>

<!-- é€šç”¨è¯­è¨€åˆ‡æ¢ç»„ä»¶HTML -->
<div class="lang-selector" id="langSelector">
    <button class="lang-trigger" id="langTrigger">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 21l5.25-11.25L21 21m-9-3h7.5M3 10.5h7.5M13.5 3H3v7.5" />
        </svg>
    </button>
    <div class="lang-dropdown">
        <button class="lang-option" id="langCn" onclick="switchLang('cn')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
            </svg>
            ä¸­æ–‡
        </button>
        <button class="lang-option" id="langEn" onclick="switchLang('en')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
            </svg>
            English
        </button>
    </div>
</div>

<!-- å¼•å…¥é€šç”¨è¯­è¨€ç»„ä»¶JS -->
<script src="common/lang-component.js"></script>

<script>
    const userId = localStorage.getItem("userId");
    // å½“å‰è¯­è¨€çŠ¶æ€
    let currentLang = localStorage.getItem('appLang') || 'cn';

    if (!userId) window.location.href = "login.html";

    // ç›‘å¬è¯­è¨€åˆ‡æ¢äº‹ä»¶ï¼Œæ›´æ–°é¡µé¢æ–‡æœ¬
    window.addEventListener('languageChange', function() {
        currentLang = localStorage.getItem('appLang') || 'cn';
        updateFormText();
    });

    // æ›´æ–°è¡¨å•æ–‡æœ¬ï¼ˆè¯­è¨€åˆ‡æ¢æ—¶è°ƒç”¨ï¼‰
    function updateFormText() {
        // æ˜µç§°è¾“å…¥æ¡†å ä½ç¬¦
        const nicknameInput = document.getElementById("nicknameInput");
        const cnNicknamePlaceholder = nicknameInput.getAttribute("placeholder");
        const enNicknamePlaceholder = nicknameInput.getAttribute("data-placeholder-en");
        nicknameInput.placeholder = currentLang === 'cn' ? cnNicknamePlaceholder : enNicknamePlaceholder;

        // ä¸ªäººç®€ä»‹è¾“å…¥æ¡†å ä½ç¬¦
        const bioInput = document.getElementById("bioInput");
        const cnBioPlaceholder = bioInput.getAttribute("placeholder");
        const enBioPlaceholder = bioInput.getAttribute("data-placeholder-en");
        bioInput.placeholder = currentLang === 'cn' ? cnBioPlaceholder : enBioPlaceholder;

        // å¤´åƒæ‚¬åœæç¤º
        const avatarOverlay = document.querySelector(".avatar-overlay");
        avatarOverlay.innerHTML = `
            <span class="cn">ğŸ“· æ›´æ¢å¤´åƒ</span>
            <span class="en">ğŸ“· Change Avatar</span>
        `;

        // ä¿å­˜æŒ‰é’®æ–‡æœ¬
        const saveBtn = document.querySelector(".save-btn");
        saveBtn.innerHTML = `
            <span class="cn">ä¿å­˜ä¿®æ”¹</span>
            <span class="en">Save Changes</span>
        `;
    }

    // 1. åŠ è½½æ•°æ®
    async function loadProfile() {
        try {
            const res = await fetch(`/api/users/${userId}`);
            const user = await res.json();

            // å¡«å……æ•°æ®
            document.getElementById("usernameInput").value = "@" + user.username; // åŠ ä¸ª@æ›´æœ‰æ„Ÿè§‰
            document.getElementById("nicknameInput").value = user.nickname || user.username;
            document.getElementById("bioInput").value = user.bio || "";
            if (user.avatar) {
                document.getElementById("avatarPreview").src = "/uploads/" + user.avatar;
            }

            // åˆå§‹åŒ–è¡¨å•æ–‡æœ¬ï¼ˆæ ¹æ®å½“å‰è¯­è¨€ï¼‰
            updateFormText();
        } catch (e) {
            const errorTip = currentLang === 'cn' ? "åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥" : "Failed to load user info";
            alert(errorTip);
        }
    }

    // 2. å¤´åƒé€‰æ‹©åçš„å³æ—¶é¢„è§ˆ (ä¸åˆ·æ–°é¡µé¢å°±èƒ½çœ‹åˆ°æ•ˆæœ)
    function previewImage(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('avatarPreview').src = e.target.result;
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    // 3. ä¿å­˜æ•°æ®
    async function saveProfile() {
        const nickname = document.getElementById("nicknameInput").value;
        const bio = document.getElementById("bioInput").value;
        const fileInput = document.getElementById("avatarInput");

        const formData = new FormData();
        formData.append("nickname", nickname);
        formData.append("bio", bio);
        // åªæœ‰å½“ç”¨æˆ·çœŸçš„é€‰äº†æ–°æ–‡ä»¶æ—¶ï¼Œæ‰ä¼  avatar
        if (fileInput.files[0]) {
            formData.append("avatar", fileInput.files[0]);
        }

        try {
            const res = await fetch(`/api/users/${userId}`, { method: 'POST', body: formData });
            const result = await res.text();

            const successText = currentLang === 'cn' ? 'æˆåŠŸ' : 'success';
            const saveSuccessText = currentLang === 'cn' ? 'ä¿å­˜æˆåŠŸï¼' : 'Saved successfully!';
            const originalBtnText = `
                <span class="cn">ä¿å­˜ä¿®æ”¹</span>
                <span class="en">Save Changes</span>
            `;

            if (result.includes(successText)) {
                // ç¨å¾®å‹å¥½çš„æç¤º
                const btn = document.querySelector(".save-btn");
                btn.innerHTML = saveSuccessText;
                btn.style.backgroundColor = "#17bf63"; // å˜ç»¿

                setTimeout(() => {
                    btn.innerHTML = originalBtnText;
                    btn.style.backgroundColor = "#1da1f2";
                    location.reload(); // åˆ·æ–°é¡µé¢æ›´æ–°çŠ¶æ€
                }, 1000);
            } else {
                alert(result);
            }
        } catch (e) {
            const errorTip = currentLang === 'cn' ? "ä¿å­˜å¤±è´¥ï¼Œç½‘ç»œé”™è¯¯" : "Save failed, network error";
            alert(errorTip);
        }
    }

    loadProfile();
</script>
</body>
</html>