<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>
        <span class="cn">ç”¨æˆ·ä¸»é¡µ</span>
        <span class="en">User Profile</span>
    </title>
    <!-- å¼•å…¥é€šç”¨è¯­è¨€ç»„ä»¶CSS -->
    <link rel="stylesheet" href="common/lang-component.css">
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background-color: #f0f2f5; margin: 0; padding-top: 70px; }

        .navbar {
            position: fixed; top: 0; width: 100%; background: white; height: 60px;
            display: flex; align-items: center; padding: 0 25px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); box-sizing: border-box; z-index: 1000;
        }
        .nav-link { margin-right: 20px; text-decoration: none; color: #555; font-weight: bold; font-size: 16px; }

        .container { max-width: 600px; margin: 20px auto; }

        /* === ä¸ªäººèµ„æ–™å¡ç‰‡ === */
        .profile-card {
            background: white;
            border-radius: 16px; /* æ›´åœ†æ¶¦ */
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 25px;
            position: relative;
        }
        .banner { height: 140px; background: linear-gradient(120deg, #a1c4fd 0%, #c2e9fb 100%); }

        /* å†…å®¹åŒºåŸŸ */
        .profile-content {
            padding: 0 20px 25px;
            position: relative;
        }

        /* å¤´åƒ - ç»å¯¹å®šä½ */
        .avatar-container {
            width: 110px; height: 110px; border-radius: 50%;
            border: 4px solid white;
            position: absolute;
            top: -55px; /* å¾€ä¸Šæä¸€åŠ */
            left: 20px;
            background: white;
            overflow: hidden;
            z-index: 2;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .avatar-img { width: 100%; height: 100%; object-fit: cover; }

        /* æŒ‰é’®åŒºåŸŸ - ç»å¯¹å®šä½åœ¨å³ä¾§ */
        .action-area {
            display: flex;
            justify-content: flex-end;
            padding-top: 15px; /* ç»™æŒ‰é’®ä¸€ç‚¹é¡¶éƒ¨ç©ºé—´ */
            margin-bottom: 10px;
            height: 40px; /* å ä½é«˜åº¦ */
        }
        .action-btn {
            padding: 8px 25px; border-radius: 20px; font-weight: bold; cursor: pointer; font-size: 15px;
        }
        /* å…³æ³¨æŒ‰é’®æ ·å¼ */
        .btn-follow { background: #0f1419; color: white; border: none; }
        .btn-follow:hover { background: #272c30; }
        /* å·²å…³æ³¨æŒ‰é’®æ ·å¼ */
        .btn-followed { background: white; border: 1px solid #cfd9de; color: #0f1419; transition: all 0.2s; }
        .btn-followed:hover { border-color: #f4212e; color: #f4212e; background-color: #fef2f2; }
        .btn-edit { background: white; border: 1px solid #cfd9de; color: #0f1419; }

        /* æ–‡æœ¬ä¿¡æ¯åŒºåŸŸ */
        .info-section { margin-top: 10px; } /* ç»™å¤´åƒä¸‹æ–¹ç•™å‡ºä¸€ç‚¹ç©ºéš™ */
        .nickname { font-size: 22px; font-weight: 900; color: #0f1419; line-height: 1.2;}
        .username { font-size: 15px; color: #536471; margin-bottom: 12px; display: block;}
        .bio { font-size: 15px; color: #333; margin-bottom: 20px; line-height: 1.5; }

        .stats { display: flex; gap: 20px; color: #536471; font-size: 15px; border-top: 1px solid #eee; padding-top: 15px;}
        .stat-num { font-weight: bold; color: #0f1419; }

        /* === æ¨æ–‡åˆ—è¡¨ä¼˜åŒ– === */
        /* æ ‡é¢˜ç‹¬ç«‹å‡ºæ¥ï¼Œä¸è¦ç™½åº• */
        .section-header {
            font-weight: 900;
            color: #333;
            font-size: 19px;
            margin-bottom: 15px;
            padding-left: 5px;
            border-left: 4px solid #1da1f2; /* è“è‰²ç«–æ¡è£…é¥° */
            line-height: 1;
        }

        /* åˆ—è¡¨ä¸éœ€è¦å¤–å±‚ç™½åº•ï¼Œç›´æ¥è£¸å¥”å¡ç‰‡ */
        .tweet {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border: 1px solid #e1e8ed;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .tweet:hover {
            background-color: #fff;
            border-color: #dbeafe;
            transform: translateY(-2px); /* æ‚¬åœè½»å¾®ä¸Šæµ® */
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
    </style>
</head>
<body>

<div class="navbar">
    <a href="javascript:history.back()" class="nav-link">â¬…
        <span class="cn">è¿”å›</span>
        <span class="en">Back</span>
    </a>
    <a href="index.html" class="nav-link">ğŸ 
        <span class="cn">å¹¿åœº</span>
        <span class="en">Plaza</span>
    </a>
</div>

<div class="container">
    <!-- é¡¶éƒ¨ä¸ªäººå¡ç‰‡ -->
    <div class="profile-card">
        <div class="banner"></div>
        <div class="profile-content">
            <div class="avatar-container">
                <img id="pAvatar" src="https://via.placeholder.com/100" class="avatar-img">
            </div>

            <!-- æŒ‰é’®åŒºåŸŸ: ä½¿ç”¨ Flex å¸ƒå±€é å³ -->
            <div id="actionArea" class="action-area"></div>

            <div class="info-section">
                <div id="pNickname" class="nickname">
                    <span class="cn">åŠ è½½ä¸­...</span>
                    <span class="en">Loading...</span>
                </div>
                <span id="pUsername" class="username">@...</span>
                <div id="pBio" class="bio"></div>

                <div class="stats">
                    <span><span id="statTweet" class="stat-num">0</span>
                        <span class="cn">ç ”ç©¶</span>
                        <span class="en">Research</span>
                    </span>
                    <span><span id="statFollower" class="stat-num">0</span>
                        <span class="cn">ç²‰ä¸</span>
                        <span class="en">Followers</span>
                    </span>
                    <span><span id="statFollowing" class="stat-num">0</span>
                        <span class="cn">å…³æ³¨</span>
                        <span class="en">Following</span>
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆ—è¡¨åŒºåŸŸ: å»æ‰äº†å¤–å±‚ç™½åº•ï¼Œæ”¹ç”¨æ ‡é¢˜+å¡ç‰‡æµ -->
    <div>
        <div class="section-header">
            <span class="cn">å…¨éƒ¨ç ”ç©¶æˆæœ</span>
            <span class="en">All Research Achievements</span>
        </div>
        <div id="tweetList"></div>
    </div>
</div>

<!-- é€šç”¨è¯­è¨€åˆ‡æ¢ç»„ä»¶HTML -->
<div class="lang-selector" id="langSelector">
    <button class="lang-trigger" id="langTrigger">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 21l5.25-11.25L21 21m-9-3h7.5M3 10.5h7.5M13.5 3H3v7.5" />
        </svg>
    </button>
    <div class="lang-dropdown">
        <button class="lang-option" id="langCn" onclick="switchLang('cn')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
            </svg>
            ä¸­æ–‡
        </button>
        <button class="lang-option" id="langEn" onclick="switchLang('en')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
            </svg>
            English
        </button>
    </div>
</div>

<!-- å¼•å…¥é€šç”¨è¯­è¨€ç»„ä»¶JS -->
<script src="common/lang-component.js"></script>

<script>
    const params = new URLSearchParams(window.location.search);
    const targetUserId = params.get("id");
    const currentUserId = localStorage.getItem("userId");
    // å½“å‰è¯­è¨€çŠ¶æ€
    let currentLang = localStorage.getItem('appLang') || 'cn';

    if (!targetUserId) {
        const errorTip = currentLang === 'cn' ? "å‚æ•°é”™è¯¯" : "Parameter error";
        alert(errorTip);
        location.href = "index.html";
    }

    // ç›‘å¬è¯­è¨€åˆ‡æ¢äº‹ä»¶ï¼Œæ›´æ–°é¡µé¢æ–‡æœ¬
    window.addEventListener('languageChange', function() {
        currentLang = localStorage.getItem('appLang') || 'cn';
        updatePageText();
        // é‡æ–°æ¸²æŸ“æŒ‰é’®å’Œç»Ÿè®¡æ–‡æœ¬
        renderButton();
        updateStatsText();
    });

    // æ›´æ–°é¡µé¢é™æ€æ–‡æœ¬ï¼ˆè¯­è¨€åˆ‡æ¢æ—¶è°ƒç”¨ï¼‰
    function updatePageText() {
        // é¡µé¢æ ‡é¢˜
        document.title = currentLang === 'cn' ? 'ç”¨æˆ·ä¸»é¡µ' : 'User Profile';

        // å¯¼èˆªæ æ–‡æœ¬
        const navLinks = document.querySelectorAll('.nav-link');
        navLinks[0].innerHTML = `â¬…
            <span class="cn">è¿”å›</span>
            <span class="en">Back</span>
        `;
        navLinks[1].innerHTML = `ğŸ 
            <span class="cn">å¹¿åœº</span>
            <span class="en">Plaza</span>
        `;

        // ç ”ç©¶æˆæœæ ‡é¢˜
        const sectionHeader = document.querySelector(".section-header");
        sectionHeader.innerHTML = `
            <span class="cn">å…¨éƒ¨ç ”ç©¶æˆæœ</span>
            <span class="en">All Research Achievements</span>
        `;

        // æ— å‘å¸ƒè®°å½•æç¤ºï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        const tweetList = document.getElementById("tweetList");
        if (tweetList.innerText.includes('æš‚æ— å‘å¸ƒè®°å½•') || tweetList.innerText.includes('No publication records')) {
            const noRecordTip = currentLang === 'cn' ? 'æš‚æ— å‘å¸ƒè®°å½•' : 'No publication records';
            tweetList.innerHTML = `<div style='padding:40px; text-align:center; color:#999'><span class="cn">${noRecordTip}</span><span class="en">${noRecordTip}</span></div>`;
        }

        // ä¸ªäººç®€ä»‹é»˜è®¤æ–‡æœ¬ï¼ˆå¦‚æœæœªå¡«å†™ï¼‰
        const bioElement = document.getElementById("pBio");
        if (bioElement.innerText === 'è¿™ä¸ªäººå¾ˆæ‡’ï¼Œä»€ä¹ˆéƒ½æ²¡å†™ã€‚' || bioElement.innerText === 'This person is lazy and hasn\'t written anything.') {
            bioElement.innerText = currentLang === 'cn' ? 'è¿™ä¸ªäººå¾ˆæ‡’ï¼Œä»€ä¹ˆéƒ½æ²¡å†™ã€‚' : 'This person is lazy and hasn\'t written anything.';
        }
    }

    // æ›´æ–°ç»Ÿè®¡é¡¹æ–‡æœ¬ï¼ˆè¯­è¨€åˆ‡æ¢æ—¶è°ƒç”¨ï¼‰
    function updateStatsText() {
        const statsItems = document.querySelectorAll(".stats span");
        const tweetText = currentLang === 'cn' ? 'ç ”ç©¶' : 'Research';
        const followerText = currentLang === 'cn' ? 'ç²‰ä¸' : 'Followers';
        const followingText = currentLang === 'cn' ? 'å…³æ³¨' : 'Following';

        statsItems[0].innerHTML = `<span id="statTweet" class="stat-num">${statsItems[0].querySelector('.stat-num').innerText}</span>
            <span class="cn">${tweetText}</span>
            <span class="en">${tweetText}</span>
        `;
        statsItems[1].innerHTML = `<span id="statFollower" class="stat-num">${statsItems[1].querySelector('.stat-num').innerText}</span>
            <span class="cn">${followerText}</span>
            <span class="en">${followerText}</span>
        `;
        statsItems[2].innerHTML = `<span id="statFollowing" class="stat-num">${statsItems[2].querySelector('.stat-num').innerText}</span>
            <span class="cn">${followingText}</span>
            <span class="en">${followingText}</span>
        `;
    }

    async function loadProfile() {
        const res = await fetch(`/api/users/${targetUserId}`);
        const user = await res.json();

        document.getElementById("pNickname").innerText = user.nickname || user.username;
        document.getElementById("pUsername").innerText = "@" + user.username;
        // ä¸ªäººç®€ä»‹é»˜è®¤æ–‡æœ¬ï¼ˆåŒè¯­è¨€ï¼‰
        document.getElementById("pBio").innerText = user.bio || (currentLang === 'cn' ? 'è¿™ä¸ªäººå¾ˆæ‡’ï¼Œä»€ä¹ˆéƒ½æ²¡å†™ã€‚' : 'This person is lazy and hasn\'t written anything.');
        if(user.avatar) document.getElementById("pAvatar").src = "/uploads/" + user.avatar;

        const statsRes = await fetch(`/api/users/${targetUserId}/stats`);
        const stats = await statsRes.json();
        document.getElementById("statTweet").innerText = stats.tweetCount;
        document.getElementById("statFollower").innerText = stats.followerCount;
        document.getElementById("statFollowing").innerText = stats.followingCount;

        // åˆå§‹åŒ–é¡µé¢æ–‡æœ¬
        updatePageText();
        updateStatsText();
        renderButton();
    }

    async function renderButton() {
        const area = document.getElementById("actionArea");

        if (targetUserId == currentUserId) {
            // ç¼–è¾‘èµ„æ–™æŒ‰é’®ï¼ˆåŒè¯­è¨€ï¼‰
            const editText = currentLang === 'cn' ? 'ç¼–è¾‘èµ„æ–™' : 'Edit Profile';
            area.innerHTML = `<button class="action-btn btn-edit" onclick="location.href='profile.html'">${editText}</button>`;
            return;
        }

        const res = await fetch(`/api/users/${currentUserId}/following`);
        const myFriends = await res.json();
        const isFollowing = myFriends.some(u => u.id == targetUserId);

        // æŒ‰é’®æ–‡æœ¬ï¼ˆåŒè¯­è¨€ï¼‰
        const followText = currentLang === 'cn' ? 'å…³æ³¨' : 'Follow';
        const followedText = currentLang === 'cn' ? 'å·²å…³æ³¨' : 'Followed';
        const unfollowText = currentLang === 'cn' ? 'å–æ¶ˆå…³æ³¨' : 'Unfollow';

        if (isFollowing) {
            area.innerHTML = `
                <button class="action-btn btn-followed"
                    onmouseover="this.innerHTML='<span class=\'cn\'>${unfollowText}</span><span class=\'en\'>${unfollowText}</span>'"
                    onmouseout="this.innerHTML='<span class=\'cn\'>${followedText}</span><span class=\'en\'>${followedText}</span>'"
                    onclick="toggleFollow(false)">
                    <span class="cn">${followedText}</span>
                    <span class="en">${followedText}</span>
                </button>`;
        } else {
            area.innerHTML = `<button class="action-btn btn-follow" onclick="toggleFollow(true)">
                <span class="cn">${followText}</span>
                <span class="en">${followText}</span>
            </button>`;
        }
    }

    async function toggleFollow(doFollow) {
        const confirmText = currentLang === 'cn' ? 'ç¡®å®šå–å…³å—ï¼Ÿ' : 'Are you sure you want to unfollow?';
        if (!doFollow && !confirm(confirmText)) return;

        const url = doFollow
            ? `/api/users/${currentUserId}/follow?targetUserId=${targetUserId}`
            : `/api/users/${currentUserId}/unfollow?targetUserId=${targetUserId}`;

        const res = await fetch(url, { method: 'POST' });
        const msg = await res.text();

        const successText = currentLang === 'cn' ? 'æˆåŠŸ' : 'success';
        const cancelText = currentLang === 'cn' ? 'å–æ¶ˆ' : 'cancelled';
        if(msg.includes(successText) || msg.includes(cancelText)) {
            renderButton();
            loadProfile();
        }
    }

    async function loadTweets() {
        const res = await fetch(`/api/tweets/user/${targetUserId}`);
        const list = await res.json();
        const container = document.getElementById("tweetList");

        const noRecordTip = currentLang === 'cn' ? 'æš‚æ— å‘å¸ƒè®°å½•' : 'No publication records';
        if (list.length === 0) {
            container.innerHTML = `<div style='padding:40px; text-align:center; color:#999'><span class="cn">${noRecordTip}</span><span class="en">${noRecordTip}</span></div>`;
            return;
        }

        list.forEach(t => {
            const timeStr = t.createTime.replace('T', ' ').split('.')[0];
            // é™„ä»¶æ–‡æœ¬ï¼ˆåŒè¯­è¨€ï¼‰
            const fileLabel = currentLang === 'cn' ? 'ğŸ“ ' : 'ğŸ“ ';
            let fileHtml = t.originalFilename ? `<div style="font-size:13px; color:#1da1f2; margin-top:8px; font-weight:bold;">${fileLabel}${t.originalFilename}</div>` : '';

            container.innerHTML += `
                <div class="tweet" onclick="location.href='detail.html?id=${t.id}'">
                    <div style="color:#536471; font-size:13px; margin-bottom:8px;">${timeStr}</div>
                    <div style="font-size:16px; line-height:1.6; color:#0f1419;">${t.content}</div>
                    ${fileHtml}
                </div>
            `;
        });
    }

    // åˆå§‹åŒ–åŠ è½½
    loadProfile();
    loadTweets();
</script>
</body>
</html>