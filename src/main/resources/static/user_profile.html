<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>
        <span class="cn">ç”¨æˆ·ä¸»é¡µ</span>
        <span class="en">User Profile</span>
    </title>
    <link rel="stylesheet" href="common/lang-component.css">
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background-color: #f0f2f5; margin: 0; padding-top: 70px; }

        .navbar {
            position: fixed; top: 0; width: 100%; background: white; height: 60px;
            display: flex; align-items: center; padding: 0 25px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); box-sizing: border-box; z-index: 1000;
        }
        .nav-link { margin-right: 20px; text-decoration: none; color: #555; font-weight: bold; font-size: 16px; }

        .container { max-width: 600px; margin: 20px auto; }

        .profile-card {
            background: white; border-radius: 16px; overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 25px; position: relative;
        }
        .banner { height: 140px; background: linear-gradient(120deg, #a1c4fd 0%, #c2e9fb 100%); }

        .profile-content { padding: 0 20px 25px; position: relative; }

        .avatar-container {
            width: 110px; height: 110px; border-radius: 50%; border: 4px solid white;
            position: absolute; top: -55px; left: 20px; background: white;
            overflow: hidden; z-index: 2; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .avatar-img { width: 100%; height: 100%; object-fit: cover; }

        .action-area {
            display: flex; justify-content: flex-end; padding-top: 15px;
            margin-bottom: 10px; height: 40px;
        }
        .action-btn {
            padding: 8px 25px; border-radius: 20px; font-weight: bold; cursor: pointer; font-size: 15px;
        }
        .btn-follow { background: #0f1419; color: white; border: none; }
        .btn-follow:hover { background: #272c30; }
        .btn-followed { background: white; border: 1px solid #cfd9de; color: #0f1419; transition: all 0.2s; }
        .btn-followed:hover { border-color: #f4212e; color: #f4212e; background-color: #fef2f2; }
        .btn-edit { background: white; border: 1px solid #cfd9de; color: #0f1419; }

        .info-section { margin-top: 10px; }
        .nickname { font-size: 22px; font-weight: 900; color: #0f1419; line-height: 1.2;}
        .username { font-size: 15px; color: #536471; margin-bottom: 12px; display: block;}
        .bio { font-size: 15px; color: #333; margin-bottom: 20px; line-height: 1.5; }

        .stats { display: flex; gap: 20px; color: #536471; font-size: 15px; border-top: 1px solid #eee; padding-top: 15px;}
        .stat-num { font-weight: bold; color: #0f1419; }

        .section-header {
            font-weight: 900; color: #333; font-size: 19px;
            margin-bottom: 15px; padding-left: 5px;
            border-left: 4px solid #1da1f2; line-height: 1;
        }

        .tweet {
            background: white; padding: 20px; border-radius: 12px;
            margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border: 1px solid #e1e8ed; cursor: pointer; transition: transform 0.2s;
        }
        .tweet:hover {
            background-color: #fff; border-color: #dbeafe;
            transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
    </style>
</head>
<body>

<div class="navbar">
    <a href="javascript:history.back()" class="nav-link">â¬…
        <span class="cn">è¿”å›</span>
        <span class="en">Back</span>
    </a>
    <a href="index.html" class="nav-link">ğŸ 
        <span class="cn">å¹¿åœº</span>
        <span class="en">Plaza</span>
    </a>
</div>

<div class="container">
    <div class="profile-card">
        <div class="banner"></div>
        <div class="profile-content">
            <div class="avatar-container">
                <img id="pAvatar" src="https://via.placeholder.com/100" class="avatar-img">
            </div>

            <div id="actionArea" class="action-area"></div>

            <div class="info-section">
                <div id="pNickname" class="nickname">Loading...</div>
                <span id="pUsername" class="username">@...</span>
                <div id="pBio" class="bio"></div>

                <div class="stats">
                    <span>
                        <span id="statTweet" class="stat-num">0</span>
                        <span class="cn">ç ”ç©¶</span><span class="en">Research</span>
                    </span>
                    <span>
                        <span id="statFollower" class="stat-num">0</span>
                        <span class="cn">ç²‰ä¸</span><span class="en">Followers</span>
                    </span>
                    <span>
                        <span id="statFollowing" class="stat-num">0</span>
                        <span class="cn">å…³æ³¨</span><span class="en">Following</span>
                    </span>
                </div>
            </div>
        </div>
    </div>

    <div>
        <div class="section-header">
            <span class="cn">å…¨éƒ¨ç ”ç©¶æˆæœ</span>
            <span class="en">All Research Achievements</span>
        </div>
        <div id="tweetList"></div>
    </div>
</div>

<div class="lang-selector" id="langSelector">
    <button class="lang-trigger" id="langTrigger">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 21l5.25-11.25L21 21m-9-3h7.5M3 10.5h7.5M13.5 3H3v7.5" />
        </svg>
    </button>
    <div class="lang-dropdown">
        <button class="lang-option" onclick="switchLang('zh')">ä¸­æ–‡</button>
        <button class="lang-option" onclick="switchLang('en')">English</button>
    </div>
</div>

<script src="common/lang-component.js"></script>

<script>
    const params = new URLSearchParams(window.location.search);
    const targetUserId = params.get("id");
    const currentUserId = localStorage.getItem("userId");

    if (!targetUserId) {
        alert("å‚æ•°é”™è¯¯ / Parameter Error");
        location.href = "index.html";
    }

    // ç›‘å¬è¯­è¨€åˆ‡æ¢
    window.addEventListener('languageChange', function() {
        const currentLang = localStorage.getItem('appLang') || 'cn';
        loadTweets();
        renderButton();
        updateBioText();
        updateStatsText(); // ç¡®ä¿ç»Ÿè®¡æ•°å­—ä¸‹çš„æ–‡å­—ä¹Ÿæ›´æ–°
    });

    async function loadProfile() {
        const res = await fetch(`/api/users/${targetUserId}`);
        const user = await res.json();

        document.getElementById("pNickname").innerText = user.nickname || user.username;
        document.getElementById("pUsername").innerText = "@" + user.username;
        document.getElementById("pBio").setAttribute("data-bio", user.bio || "");
        updateBioText();

        if(user.avatar) document.getElementById("pAvatar").src = "/uploads/" + user.avatar;

        const statsRes = await fetch(`/api/users/${targetUserId}/stats`);
        const stats = await statsRes.json();
        document.getElementById("statTweet").innerText = stats.tweetCount;
        document.getElementById("statFollower").innerText = stats.followerCount;
        document.getElementById("statFollowing").innerText = stats.followingCount;

        renderButton();
    }

    function updateBioText() {
        const bioEl = document.getElementById("pBio");
        const rawBio = bioEl.getAttribute("data-bio");
        const currentLang = localStorage.getItem('appLang') || 'cn';

        if (rawBio) {
            bioEl.innerText = rawBio;
        } else {
            bioEl.innerText = currentLang === 'cn' ? 'è¿™ä¸ªäººå¾ˆæ‡’ï¼Œä»€ä¹ˆéƒ½æ²¡å†™ã€‚' : 'This person is lazy and hasn\'t written anything.';
        }
    }

    // æ›´æ–°ç»Ÿè®¡æ æ–‡å­—ï¼ˆé˜²æ­¢åŠ¨æ€ç”Ÿæˆåä¸¢å¤±æ ·å¼ï¼‰
    function updateStatsText() {
        if(typeof applyLang === 'function') applyLang(localStorage.getItem('appLang') || 'cn');
    }

    async function renderButton() {
        const area = document.getElementById("actionArea");

        // 1. åˆ¤æ–­æ˜¯å¦æ˜¯è‡ªå·±
        if (targetUserId == currentUserId) {
            area.innerHTML = `
                <button class="action-btn btn-edit" onclick="location.href='profile.html'">
                    <span class="cn">ç¼–è¾‘èµ„æ–™</span>
                    <span class="en">Edit Profile</span>
                </button>`;

            // ğŸ”¥ å…³é”®ä¿®å¤ï¼šæ’å…¥HTMLåç«‹å³åº”ç”¨è¯­è¨€è§„åˆ™
            if(typeof applyLang === 'function') applyLang(localStorage.getItem('appLang') || 'cn');
            return;
        }

        // 2. åˆ¤æ–­æ˜¯å¦å·²å…³æ³¨
        const res = await fetch(`/api/users/${currentUserId}/following`);
        const myFriends = await res.json();
        const isFollowing = myFriends.some(u => u.id == targetUserId);

        if (isFollowing) {
            area.innerHTML = `
                <button class="action-btn btn-followed" onclick="toggleFollow(false)"
                    onmouseover="showUnfollowText(this)" onmouseout="showFollowedText(this)">
                    <span class="cn">å·²å…³æ³¨</span>
                    <span class="en">Followed</span>
                </button>`;
        } else {
            area.innerHTML = `
                <button class="action-btn btn-follow" onclick="toggleFollow(true)">
                    <span class="cn">å…³æ³¨</span>
                    <span class="en">Follow</span>
                </button>`;
        }

        // ğŸ”¥ å…³é”®ä¿®å¤ï¼šæ’å…¥HTMLåç«‹å³åº”ç”¨è¯­è¨€è§„åˆ™
        if(typeof applyLang === 'function') applyLang(localStorage.getItem('appLang') || 'cn');
    }

    function showUnfollowText(btn) {
        // é¼ æ ‡æ‚¬åœæ—¶æ‰‹åŠ¨ä¿®æ”¹åŒè¯­æ ‡ç­¾çš„å†…å®¹
        const cnSpan = btn.querySelector('.cn');
        const enSpan = btn.querySelector('.en');
        if(cnSpan) cnSpan.innerText = "å–æ¶ˆå…³æ³¨";
        if(enSpan) enSpan.innerText = "Unfollow";
    }

    function showFollowedText(btn) {
        // é¼ æ ‡ç§»å‡ºæ—¶æ¢å¤
        const cnSpan = btn.querySelector('.cn');
        const enSpan = btn.querySelector('.en');
        if(cnSpan) cnSpan.innerText = "å·²å…³æ³¨";
        if(enSpan) enSpan.innerText = "Followed";
    }

    async function toggleFollow(doFollow) {
        const lang = localStorage.getItem('appLang') || 'cn';
        const confirmText = lang === 'cn' ? 'ç¡®å®šå–å…³å—ï¼Ÿ' : 'Are you sure you want to unfollow?';

        if (!doFollow && !confirm(confirmText)) return;

        const url = doFollow
            ? `/api/users/${currentUserId}/follow?targetUserId=${targetUserId}`
            : `/api/users/${currentUserId}/unfollow?targetUserId=${targetUserId}`;

        const res = await fetch(url, { method: 'POST' });
        const msg = await res.text();

        if(msg.includes("æˆåŠŸ") || msg.includes("success") || msg.includes("å–æ¶ˆ") || msg.includes("cancelled")) {
            renderButton();
            loadProfile();
        }
    }

    async function loadTweets() {
        const res = await fetch(`/api/tweets/user/${targetUserId}`);
        const list = await res.json();
        const container = document.getElementById("tweetList");
        const currentLang = localStorage.getItem('appLang') || 'cn';

        if (list.length === 0) {
            container.innerHTML = `
                <div style='padding:40px; text-align:center; color:#999'>
                    <span class="cn">æš‚æ— å‘å¸ƒè®°å½•</span>
                    <span class="en">No publication records</span>
                </div>`;
            if(typeof applyLang === 'function') applyLang(currentLang);
            return;
        }

        container.innerHTML = "";
        list.forEach(t => {
            const timeStr = t.createTime.replace('T', ' ').split('.')[0];
            let fileHtml = t.originalFilename ? `<div style="font-size:13px; color:#1da1f2; margin-top:8px; font-weight:bold;">ğŸ“ ${t.originalFilename}</div>` : '';

            container.innerHTML += `
                <div class="tweet" onclick="location.href='detail.html?id=${t.id}'">
                    <div style="color:#536471; font-size:13px; margin-bottom:8px;">${timeStr}</div>
                    <div style="font-size:16px; line-height:1.6; color:#0f1419;">${t.content}</div>
                    ${fileHtml}
                </div>
            `;
        });

        if(typeof applyLang === 'function') applyLang(currentLang);
    }

    loadProfile();
    loadTweets();
</script>
</body>
</html>