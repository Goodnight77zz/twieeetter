<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>
        <span class="cn">ç¨¿ä»¶ç®¡ç† - åˆ›ä½œä¸­å¿ƒ</span>
        <span class="en">Manuscript Management - Creator Center</span>
    </title>
    <link rel="stylesheet" href="common/lang-component.css">
    <style>
        /* å¤ç”¨å¸ƒå±€ CSS */
        body { margin: 0; font-family: 'Segoe UI', Arial, sans-serif; background-color: #f4f5f7; display: flex; height: 100vh; overflow: hidden; }

        /* ä¾§è¾¹æ  */
        .sidebar { width: 240px; background: white; border-right: 1px solid #e7e7e7; display: flex; flex-direction: column; padding-top: 20px; flex-shrink: 0; }
        .logo-area { padding: 0 24px 20px; font-size: 20px; font-weight: 900; color: #00a1d6; border-bottom: 1px solid #eee; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; text-decoration: none; }

        .post-btn-wrapper { padding: 0 20px; margin-bottom: 20px; }
        .big-post-btn { display: flex; justify-content: center; align-items: center; width: 100%; background-color: #00a1d6; color: white; padding: 12px; border-radius: 4px; font-size: 16px; font-weight: bold; text-decoration: none; box-sizing: border-box; transition: 0.2s; }
        .big-post-btn:hover { background-color: #00b5e5; }

        .menu-item { padding: 12px 24px; color: #505050; text-decoration: none; font-size: 15px; display: flex; align-items: center; transition: background 0.2s; }
        .menu-item:hover { background-color: #f4f5f7; color: #00a1d6; }
        .menu-item.active { color: #00a1d6; background-color: #eefaff; border-left: 3px solid #00a1d6; }
        .menu-icon { margin-right: 10px; font-size: 18px; width: 20px; text-align: center;}

        /* å†…å®¹åŒº */
        .main-content { flex: 1; padding: 30px; overflow-y: auto; }
        .page-header { font-size: 20px; font-weight: bold; color: #333; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #eee; }

        /* åˆ—è¡¨æ ·å¼ */
        .content-list { background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); overflow: hidden; }
        .list-item { display: flex; padding: 20px; border-bottom: 1px solid #f0f0f0; transition: background 0.1s; align-items: flex-start; }
        .list-item:hover { background-color: #fafafa; }
        .list-item:last-child { border-bottom: none; }

        .item-icon { font-size: 24px; margin-right: 15px; background: #f0f5ff; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; border-radius: 6px; color: #00a1d6; flex-shrink: 0; }

        .item-info { flex: 1; overflow: hidden; }
        .item-title { font-size: 16px; font-weight: bold; color: #333; margin-bottom: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; }
        .item-title:hover { color: #00a1d6; }

        .item-meta { font-size: 13px; color: #999; display: flex; gap: 20px; }

        .item-actions { margin-left: 20px; }
        .btn-view { padding: 6px 15px; border: 1px solid #ddd; border-radius: 4px; color: #666; text-decoration: none; font-size: 13px; transition: 0.2s; }
        .btn-view:hover { border-color: #00a1d6; color: #00a1d6; }

        /* è¾…åŠ©æ ·å¼ */
        .toast {
            position: fixed; top: 20px; right: 20px; padding: 15px;
            background: #dc3545; color: white; border-radius: 5px;
            z-index: 10000; opacity: 0; transition: opacity 0.3s;
        }
        .toast.show { opacity: 1; }

        /* ç­›é€‰åŒºæ ·å¼ä¼˜åŒ– */
        .filter-area { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; }
        .form-select {
            padding: 8px 12px; font-size: 14px; border: 1px solid #ddd;
            border-radius: 4px; outline: none; transition: border 0.2s;
            background: white; color: #333; min-width: 150px; cursor: pointer;
        }
        .form-select:focus { border-color: #00a1d6; }
        .form-label { font-weight: bold; color: #444; font-size: 14px;}
    </style>
</head>
<body>

<div class="sidebar">
    <a href="index.html" class="logo-area">ğŸ“
        <span class="cn">åˆ›ä½œä¸­å¿ƒ</span>
        <span class="en">Creator Center</span>
    </a>

    <div class="post-btn-wrapper">
        <a href="publish.html" class="big-post-btn">ğŸ“
            <span class="cn">å‘å¸ƒæ–°ç ”ç©¶</span>
            <span class="en">Publish New Research</span>
        </a>
    </div>

    <a href="dashboard.html" class="menu-item">
        <span class="menu-icon">ğŸ </span>
        <span class="cn">é¦–é¡µæ¦‚è§ˆ</span>
        <span class="en">Home Overview</span>
    </a>
    <a href="content.html" class="menu-item active">
        <span class="menu-icon">ğŸ“‚</span>
        <span class="cn">ç¨¿ä»¶ç®¡ç†</span>
        <span class="en">Manuscripts</span>
    </a>
    <a href="index.html" class="menu-item">
        <span class="menu-icon">ğŸŒ</span>
        <span class="cn">è¿”å›å¹¿åœº</span>
        <span class="en">Back to Plaza</span>
    </a>
</div>

<div class="main-content">
    <div class="page-header">
        <span class="cn">æˆ‘çš„ç¨¿ä»¶</span>
        <span class="en">My Manuscripts</span>
    </div>

    <!-- ç­›é€‰åŒºåŸŸ -->
    <div class="filter-area">
        <label class="form-label filter-form-label">
            <span class="cn">æ ‡ç­¾ç­›é€‰ï¼š</span>
            <span class="en">Tag Filterï¼š</span>
        </label>
        <select id="tagFilter" class="form-select">
            <!-- Value å¿…é¡»ä¿æŒä¸­æ–‡ï¼Œå› ä¸ºæ•°æ®åº“å­˜çš„æ˜¯ä¸­æ–‡ -->
            <option value="">å…¨éƒ¨æ ‡ç­¾</option>
            <option value="AI">AI</option>
            <option value="ç”Ÿç‰©åŒ»å­¦">ç”Ÿç‰©åŒ»å­¦</option>
            <option value="è®¡ç®—æœº">è®¡ç®—æœº</option>
            <option value="ç‰©ç†">ç‰©ç†</option>
            <option value="åŒ–å­¦">åŒ–å­¦</option>
            <option value="æ·±åº¦å­¦ä¹ ">æ·±åº¦å­¦ä¹ </option>
            <option value="æ•°æ®åˆ†æ">æ•°æ®åˆ†æ</option>
            <option value="æœªåˆ†ç±»">æœªåˆ†ç±»</option>
        </select>
    </div>

    <div class="content-list" id="contentList">
        <div style="padding: 40px; text-align: center; color: #999;">
            <span class="cn">åŠ è½½ä¸­...</span>
            <span class="en">Loading...</span>
        </div>
    </div>
</div>

<!-- è¯­è¨€åˆ‡æ¢æ‚¬æµ®çƒ -->
<div class="lang-selector" id="langSelector">
    <button class="lang-trigger" id="langTrigger">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 21l5.25-11.25L21 21m-9-3h7.5M3 10.5h7.5M13.5 3H3v7.5" />
        </svg>
    </button>
    <div class="lang-dropdown">
        <button class="lang-option" id="langCn" onclick="switchLang('cn')">ä¸­æ–‡</button>
        <button class="lang-option" id="langEn" onclick="switchLang('en')">English</button>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="common/lang-component.js"></script>

<script>
    // === æ ¸å¿ƒä¿®å¤ï¼šæ ‡ç­¾ç¿»è¯‘å­—å…¸ ===
    const tagTranslations = {
        "AI": "AI",
        "ç”Ÿç‰©åŒ»å­¦": "Biomedical",
        "è®¡ç®—æœº": "Comp Sci",
        "ç‰©ç†": "Physics",
        "åŒ–å­¦": "Chemistry",
        "æ·±åº¦å­¦ä¹ ": "Deep Learning",
        "æ•°æ®åˆ†æ": "Data Analysis",
        "æœªåˆ†ç±»": "Unclassified",
        "": "All Tags" // ç©ºå€¼å¯¹åº”å…¨éƒ¨æ ‡ç­¾
    };

    // é»˜è®¤ï¼ˆä¸­æ–‡ï¼‰æ ‡ç­¾åï¼Œç”¨äºåˆ‡å›ä¸­æ–‡æ—¶æ¢å¤
    const tagOriginals = {
        "AI": "AI",
        "ç”Ÿç‰©åŒ»å­¦": "ç”Ÿç‰©åŒ»å­¦",
        "è®¡ç®—æœº": "è®¡ç®—æœº",
        "ç‰©ç†": "ç‰©ç†",
        "åŒ–å­¦": "åŒ–å­¦",
        "æ·±åº¦å­¦ä¹ ": "æ·±åº¦å­¦ä¹ ",
        "æ•°æ®åˆ†æ": "æ•°æ®åˆ†æ",
        "æœªåˆ†ç±»": "æœªåˆ†ç±»",
        "": "å…¨éƒ¨æ ‡ç­¾"
    };

    function showToast(msg, type = 'error') {
        const toast = document.createElement('div');
        toast.className = 'toast show';
        toast.style.background = type === 'success' ? '#198754' : '#dc3545';
        toast.textContent = msg;
        document.body.appendChild(toast);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => document.body.removeChild(toast), 300);
        }, 2000);
    }

    const userId = localStorage.getItem("userId");
    if(!userId) window.location.href = "login.html";

    let currentLang = localStorage.getItem('appLang') || 'cn';
    let allContents = [];

    // ç›‘å¬è¯­è¨€åˆ‡æ¢
    window.addEventListener('languageChange', function() {
        currentLang = localStorage.getItem('appLang') || 'cn';
        // 1. æ›´æ–°ç­›é€‰æ¡†é‡Œçš„é€‰é¡¹æ–‡å­—
        updateFilterOptionsText();
        // 2. é‡æ–°æ¸²æŸ“åˆ—è¡¨ï¼ˆè®©åˆ—è¡¨é‡Œçš„ "æŸ¥çœ‹è¯¦æƒ…" æŒ‰é’®å’Œæ ‡ç­¾å¾½ç« ä¹Ÿèƒ½å˜è¯­è¨€ï¼‰
        filterContentsByTag();
    });

    // === æ ¸å¿ƒä¿®å¤ï¼šåŠ¨æ€æ›´æ–°ä¸‹æ‹‰æ¡†æ–‡å­— ===
    function updateFilterOptionsText() {
        const select = document.getElementById('tagFilter');
        const options = select.options;

        for (let i = 0; i < options.length; i++) {
            const val = options[i].value; // è·å– value (å§‹ç»ˆæ˜¯ä¸­æ–‡ï¼Œå¦‚ "è®¡ç®—æœº")

            if (currentLang === 'en') {
                // å¦‚æœæ˜¯è‹±æ–‡æ¨¡å¼ï¼Œæ˜¾ç¤ºç¿»è¯‘åçš„æ–‡æœ¬
                options[i].text = tagTranslations[val] || val;
            } else {
                // å¦‚æœæ˜¯ä¸­æ–‡æ¨¡å¼ï¼Œæ˜¾ç¤ºåŸå§‹ä¸­æ–‡æ–‡æœ¬
                options[i].text = tagOriginals[val] || val;
            }
        }
    }

    document.getElementById('tagFilter').addEventListener('change', function() {
        filterContentsByTag();
    });

    function filterContentsByTag() {
        const selectedTag = document.getElementById('tagFilter').value;
        const container = document.getElementById("contentList");
        container.innerHTML = "";

        const filtered = selectedTag
            ? allContents.filter(item => {
                const tagsStr = item.tags || 'æœªåˆ†ç±»';
                // ç­›é€‰ä»ç„¶ä½¿ç”¨ valueï¼ˆä¸­æ–‡ï¼‰è¿›è¡Œæ¯”å¯¹ï¼Œå› ä¸ºæ•°æ®åº“é‡Œå­˜çš„æ˜¯ä¸­æ–‡
                return tagsStr.includes(selectedTag);
            })
            : allContents;

        if(filtered.length === 0) {
            container.innerHTML = `
                <div style="padding: 40px; text-align: center; color: #999;">
                    <span class="cn">æš‚æ— ç¬¦åˆæ¡ä»¶çš„ç¨¿ä»¶</span>
                    <span class="en">No manuscripts matching the condition</span>
                </div>
            `;
            if (typeof applyLang === "function") applyLang(currentLang);
            return;
        }

        const publishTimeText = currentLang === 'cn' ? 'å‘å¸ƒæ—¶é—´' : 'Publish Time';
        const attachmentText = currentLang === 'cn' ? 'é™„ä»¶' : 'Attachment';
        const noAttachmentText = currentLang === 'cn' ? 'æ— ' : 'None';

        filtered.forEach(item => {
            const timeStr = item.createTime ? item.createTime.replace('T', ' ').split('.')[0] : 'Time Unknown';
            const titlePreview = item.content.length > 30 ? item.content.substring(0, 30) + "..." : item.content;

            // æ¸²æŸ“åˆ—è¡¨é‡Œçš„æ ‡ç­¾å¾½ç«  (ä¹Ÿéœ€è¦ç¿»è¯‘)
            const tagsStr = item.tags || '';
            const tagsHtml = tagsStr ? tagsStr.split(',').map(tag => {
                // åœ¨åˆ—è¡¨å±•ç¤ºæ—¶ï¼Œä¹Ÿæ ¹æ®å½“å‰è¯­è¨€ç¿»è¯‘æ ‡ç­¾
                const displayTag = currentLang === 'en' ? (tagTranslations[tag] || tag) : tag;
                return `<span class="badge bg-primary-subtle text-primary me-1" style="font-size: 11px; padding: 2px 5px; border:1px solid #cce5ff; border-radius:4px; color:#007bff; background:#f0f8ff;">${displayTag}</span>`;
            }).join('') : '<span style="font-size:11px; color:#999;">(No Tags)</span>';

            container.innerHTML += `
                <div class="list-item">
                    <div class="item-icon">ğŸ“„</div>
                    <div class="item-info">
                        <div class="item-title" onclick="location.href='detail.html?id=${item.id}'">${titlePreview}</div>
                        <div style="margin-bottom: 8px;">${tagsHtml}</div>
                        <div class="item-meta">
                            <span>${publishTimeText}: ${timeStr}</span>
                            <span>${attachmentText}: ${item.originalFilename || noAttachmentText}</span>
                        </div>
                    </div>
                    <div class="item-actions">
                        <a href="detail.html?id=${item.id}" class="btn-view">
                            <span class="cn">æŸ¥çœ‹è¯¦æƒ…</span>
                            <span class="en">View Details</span>
                        </a>
                    </div>
                </div>
            `;
        });

        if (typeof applyLang === "function") applyLang(currentLang);
    }

    async function loadMyContents() {
        const container = document.getElementById("contentList");
        container.innerHTML = `
            <div style="padding: 40px; text-align: center; color: #999;">
                <span class="cn">åŠ è½½ä¸­...</span>
                <span class="en">Loading...</span>
            </div>
        `;
        if (typeof applyLang === "function") applyLang(currentLang);

        try {
            const res = await fetch(`/api/tweets/user/${userId}`);
            allContents = await res.json();

            // åˆå§‹åŒ–æ—¶æ›´æ–°ä¸‹æ‹‰æ¡†è¯­è¨€
            updateFilterOptionsText();
            filterContentsByTag();
        } catch (e) {
            container.innerHTML = `
                <div style="padding: 40px; text-align: center; color: #999;">
                    <span class="cn">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</span>
                    <span class="en">Load failed, please refresh and try again</span>
                </div>
            `;
            if (typeof applyLang === "function") applyLang(currentLang);
            showToast(currentLang === 'cn' ? "åŠ è½½ç¨¿ä»¶å¤±è´¥ï¼" : "Failed to load manuscripts!");
        }
    }

    loadMyContents();
</script>
</body>
</html>