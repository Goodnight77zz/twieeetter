<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>
        <span class="cn">å‘å¸ƒç ”ç©¶ - åˆ›ä½œä¸­å¿ƒ</span>
        <span class="en">Publish Research - Creator Center</span>
    </title>
    <!-- å¼•å…¥é€šç”¨è¯­è¨€ç»„ä»¶CSS -->
    <link rel="stylesheet" href="common/lang-component.css">
    <style>
        /* å¤ç”¨åŸºç¡€å¸ƒå±€ CSS */
        body { margin: 0; font-family: 'Segoe UI', Arial, sans-serif; background-color: #f4f5f7; display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 240px; background: white; border-right: 1px solid #e7e7e7; display: flex; flex-direction: column; padding: 20px 0; flex-shrink: 0; }
        .logo { padding: 0 24px 20px; font-size: 22px; font-weight: 900; color: #00a1d6; border-bottom: 1px solid #eee; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;}
        .post-btn-container { padding: 0 20px; margin-bottom: 20px; }
        .big-post-btn { width: 100%; background-color: #00a1d6; color: white; border: none; padding: 12px; border-radius: 4px; font-size: 16px; cursor: pointer; display: flex; justify-content: center; align-items: center; font-weight: bold; text-decoration: none; box-sizing: border-box;}

        .menu-item { padding: 12px 24px; color: #505050; text-decoration: none; font-size: 15px; display: flex; align-items: center; transition: background 0.2s; }
        .menu-item:hover { background-color: #f4f5f7; color: #00a1d6; }
        .menu-icon { margin-right: 10px; font-size: 18px; width: 20px; text-align: center;}

        .main-content { flex: 1; padding: 30px; overflow-y: auto; background-color: #f4f5f7; }

        /* === å‘å¸ƒè¡¨å•åŒºåŸŸ === */
        .editor-container { background: white; max-width: 800px; margin: 0 auto; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); padding: 40px; }
        .page-header { border-bottom: 1px solid #eee; padding-bottom: 20px; margin-bottom: 30px; }
        .page-header h2 { margin: 0; color: #333; font-size: 24px; font-weight: 800; }

        .form-group { margin-bottom: 30px; }
        .form-label { display: block; margin-bottom: 12px; font-weight: 700; color: #2c3e50; font-size: 15px; }

        textarea { width: 100%; height: 200px; border: 1px solid #e1e8ed; border-radius: 8px; padding: 15px; font-size: 16px; font-family: inherit; resize: vertical; outline: none; box-sizing: border-box; transition: all 0.2s; background: #f8f9fa;}
        textarea:focus { border-color: #00a1d6; background: white; box-shadow: 0 0 0 3px rgba(0, 161, 214, 0.1); }

        /* æ–‡ä»¶ä¸Šä¼ åŒºåŸŸç¾åŒ– */
        .file-upload-box {
            border: 2px dashed #cfd9de; border-radius: 12px; padding: 40px;
            text-align: center; background-color: #f8f9fa; cursor: pointer;
            transition: all 0.2s; position: relative; overflow: hidden;
        }
        .file-upload-box:hover { border-color: #00a1d6; background-color: #f0faff; }
        .upload-icon { font-size: 48px; color: #aab8c2; margin-bottom: 15px; display: block; transition: transform 0.2s;}
        .file-upload-box:hover .upload-icon { transform: scale(1.1); color: #00a1d6; }
        .upload-text { color: #657786; font-size: 14px; }
        #fileNameDisplay { margin-top: 15px; color: #00a1d6; font-weight: bold; font-size: 14px; background: rgba(0, 161, 214, 0.1); display: inline-block; padding: 5px 15px; border-radius: 20px; }

        /* === æ ‡ç­¾åŒºåŸŸç¾åŒ– (UI å‡çº§é‡ç‚¹) === */
        .tag-container { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; }

        /* èƒ¶å›ŠæŒ‰é’®æ ·å¼ */
        .tag-btn {
            padding: 8px 18px; font-size: 14px; border: 1px solid #e1e8ed;
            background: white; color: #536471; border-radius: 50px; /* åœ†è§’èƒ¶å›Š */
            cursor: pointer; transition: all 0.2s ease; font-weight: 500;
            display: flex; align-items: center; gap: 5px;
        }
        .tag-btn:hover {
            background: #f7f9f9; border-color: #00a1d6; color: #00a1d6; transform: translateY(-1px);
        }
        .tag-btn.active {
            background: #00a1d6; color: white; border-color: #00a1d6;
            box-shadow: 0 4px 10px rgba(0, 161, 214, 0.3);
        }

        /* è‡ªå®šä¹‰æ ‡ç­¾è¾“å…¥æ¡†ç¾åŒ– */
        .form-control {
            width: 100%; padding: 10px 15px; font-size: 14px;
            border: 1px solid #e1e8ed; border-radius: 8px;
            box-sizing: border-box; outline: none; transition: all 0.2s;
            background: #f8f9fa;
        }
        .form-control:focus { border-color: #00a1d6; background: white; }

        /* å·²é€‰æ ‡ç­¾å±•ç¤ºåŒº */
        #selectedTags { min-height: 30px; display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .selected-tag-badge {
            background: #e8f5fe; color: #00a1d6; padding: 5px 12px;
            border-radius: 6px; font-size: 13px; font-weight: bold;
            display: flex; align-items: center; gap: 8px; border: 1px solid #bce3ff;
        }
        .btn-close-tag {
            cursor: pointer; font-size: 14px; opacity: 0.6; transition: 0.2s;
        }
        .btn-close-tag:hover { opacity: 1; color: #ff4d4f; }

        .action-bar { margin-top: 40px; text-align: right; border-top: 1px solid #eee; padding-top: 20px; }
        .submit-btn {
            background: linear-gradient(90deg, #00a1d6, #00b5e5);
            color: white; border: none; padding: 12px 50px;
            border-radius: 30px; font-size: 16px; cursor: pointer;
            font-weight: bold; box-shadow: 0 4px 15px rgba(0, 161, 214, 0.3);
            transition: all 0.2s;
        }
        .submit-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0, 161, 214, 0.4); }

        /* æç¤ºæ¡† */
        .toast {
            position: fixed; top: 20px; right: 20px; padding: 15px 25px;
            background: #dc3545; color: white; border-radius: 8px;
            z-index: 10000; opacity: 0; transition: opacity 0.3s;
            font-weight: bold; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .toast.show { opacity: 1; }
        .toast.success { background: #10b981; }
    </style>
</head>
<body>

<!-- ä¾§è¾¹æ  -->
<div class="sidebar">
    <div class="logo">ğŸŒŠ
        <span class="cn">åˆ›ä½œä¸­å¿ƒ</span>
        <span class="en">Creator Center</span>
    </div>

    <div class="post-btn-container">
        <a href="publish.html" class="big-post-btn" style="background-color:#00b5e5;">
            ğŸ“
            <span class="cn">å‘å¸ƒæ–°ç ”ç©¶</span>
            <span class="en">Publish New Research</span>
        </a>
    </div>

    <!-- ä¾§è¾¹æ åŒè¯­ -->
    <a href="dashboard.html" class="menu-item">
        <span class="menu-icon">ğŸ </span>
        <span class="cn">é¦–é¡µæ¦‚è§ˆ</span>
        <span class="en">Home Overview</span>
    </a>
    <a href="content.html" class="menu-item">
        <span class="menu-icon">ğŸ“‚</span>
        <span class="cn">ç¨¿ä»¶ç®¡ç†</span>
        <span class="en">Manuscripts</span>
    </a>
    <a href="index.html" class="menu-item">
        <span class="menu-icon">ğŸŒ</span>
        <span class="cn">è¿”å›å¹¿åœº</span>
        <span class="en">Back to Plaza</span>
    </a>
</div>

<!-- ä¸»ç¼–è¾‘åŒº -->
<div class="main-content">
    <div class="editor-container">
        <div class="page-header">
            <h2>
                <span class="cn">å‘å¸ƒç ”ç©¶æˆæœ</span>
                <span class="en">Publish Research Achievement</span>
            </h2>
        </div>

        <div class="form-group">
            <label class="form-label">
                <span class="cn">ç ”ç©¶æè¿° / æ‘˜è¦</span>
                <span class="en">Research Description / Abstract</span>
            </label>
            <textarea id="tweetContent" placeholder="è¯·è¾“å…¥è®ºæ–‡çš„æ ‡é¢˜ã€æ‘˜è¦æˆ–ä¸»è¦ç ”ç©¶æˆæœè¯´æ˜..." data-placeholder-en="Please enter the paper's title, abstract or main research achievements..."></textarea>
        </div>

        <div class="form-group">
            <label class="form-label">
                <span class="cn">ä¸Šä¼ é™„ä»¶ (è®ºæ–‡/æ–‡æ¡£)</span>
                <span class="en">Upload Attachment (Paper/Document)</span>
            </label>
            <div class="file-upload-box" onclick="document.getElementById('paperFile').click()">
                <span class="upload-icon">â˜ï¸</span>
                <div class="upload-text">
                    <span class="cn">ç‚¹å‡»æ­¤å¤„ä¸Šä¼ æ–‡ä»¶ (æ”¯æŒ PDF, Word)</span>
                    <span class="en">Click here to upload files (Supports PDF, Word)</span>
                </div>
                <div id="fileNameDisplay"></div>
            </div>
            <input type="file" id="paperFile" accept=".pdf,.doc,.docx" style="display: none;" onchange="showFileName()">
        </div>

        <!-- æ ‡ç­¾é€‰æ‹©åŒºåŸŸ -->
        <div class="form-group">
            <label class="form-label tag-form-label">
                <span class="cn">è®ºæ–‡æ ‡ç­¾ï¼ˆå¯å¤šé€‰ï¼‰</span>
                <span class="en">Paper Tags (Multi-select)</span>
            </label>

            <div class="tag-container">
                <!-- æ³¨æ„ï¼šdata-tag å­˜å‚¨çš„æ˜¯å‘ç»™åç«¯çš„ä¸­æ–‡å€¼ï¼Œå†…éƒ¨ span ç”¨äºæ˜¾ç¤º -->
                <button type="button" class="tag-btn" data-tag="AI">
                    AI
                </button>
                <button type="button" class="tag-btn" data-tag="ç”Ÿç‰©åŒ»å­¦">
                    <span class="cn">ç”Ÿç‰©åŒ»å­¦</span><span class="en">Biomedical</span>
                </button>
                <button type="button" class="tag-btn" data-tag="è®¡ç®—æœº">
                    <span class="cn">è®¡ç®—æœº</span><span class="en">Comp Sci</span>
                </button>
                <button type="button" class="tag-btn" data-tag="ç‰©ç†">
                    <span class="cn">ç‰©ç†</span><span class="en">Physics</span>
                </button>
                <button type="button" class="tag-btn" data-tag="åŒ–å­¦">
                    <span class="cn">åŒ–å­¦</span><span class="en">Chemistry</span>
                </button>
                <button type="button" class="tag-btn" data-tag="æ·±åº¦å­¦ä¹ ">
                    <span class="cn">æ·±åº¦å­¦ä¹ </span><span class="en">Deep Learning</span>
                </button>
                <button type="button" class="tag-btn" data-tag="æ•°æ®åˆ†æ">
                    <span class="cn">æ•°æ®åˆ†æ</span><span class="en">Data Analysis</span>
                </button>
            </div>

            <input type="text" class="form-control mb-2" id="customTag"
                   placeholder="è¾“å…¥è‡ªå®šä¹‰æ ‡ç­¾ï¼ŒæŒ‰å›è½¦æ·»åŠ "
                   data-placeholder-en="Enter custom tag, press Enter to add">

            <!-- å·²é€‰æ ‡ç­¾å±•ç¤ºåŒº -->
            <div id="selectedTags"></div>

            <!-- éšè—è¾“å…¥æ¡†ï¼šå­˜å‚¨æœ€ç»ˆæ ‡ç­¾å­—ç¬¦ä¸² -->
            <input type="hidden" id="finalTags" value="">
        </div>

        <div class="action-bar">
            <button class="submit-btn" onclick="postTweet()">
                <span class="cn">ç«‹å³å‘å¸ƒ</span>
                <span class="en">Publish Now</span>
            </button>
        </div>
    </div>
</div>

<!-- è¯­è¨€é€‰æ‹©å™¨ -->
<div class="lang-selector" id="langSelector">
    <button class="lang-trigger" id="langTrigger">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 21l5.25-11.25L21 21m-9-3h7.5M3 10.5h7.5M13.5 3H3v7.5" />
        </svg>
    </button>
    <div class="lang-dropdown">
        <button class="lang-option" id="langCn" onclick="switchLang('cn')">ä¸­æ–‡</button>
        <button class="lang-option" id="langEn" onclick="switchLang('en')">English</button>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="common/lang-component.js"></script>

<script>
    // æ ‡ç­¾çš„ä¸­è‹±å¯¹ç…§è¡¨ (ç”¨äºåœ¨JSé‡Œæ¸²æŸ“é€‰ä¸­æ ‡ç­¾æ—¶ç¿»è¯‘)
    const tagTranslations = {
        "AI": "AI",
        "ç”Ÿç‰©åŒ»å­¦": "Biomedical",
        "è®¡ç®—æœº": "Comp Sci",
        "ç‰©ç†": "Physics",
        "åŒ–å­¦": "Chemistry",
        "æ·±åº¦å­¦ä¹ ": "Deep Learning",
        "æ•°æ®åˆ†æ": "Data Analysis"
    };

    function showToast(msg, type = 'error') {
        const toast = document.createElement('div');
        toast.className = `toast show ${type}`;
        toast.textContent = msg;
        document.body.appendChild(toast);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => document.body.removeChild(toast), 300);
        }, 2000);
    }

    const userId = localStorage.getItem("userId");
    let currentLang = localStorage.getItem('appLang') || 'cn';
    let selectedTags = new Set(); // å­˜å‚¨é€‰ä¸­çš„æ ‡ç­¾ï¼ˆå€¼å§‹ç»ˆæ˜¯ä¸­æ–‡ï¼Œä¿è¯ä¼ ç»™åç«¯ç»Ÿä¸€ï¼‰

    if(!userId) window.location.href = "login.html";

    // ç›‘å¬è¯­è¨€åˆ‡æ¢
    window.addEventListener('languageChange', function() {
        currentLang = localStorage.getItem('appLang') || 'cn';
        updateFormText();
        updateSelectedTags(); // é‡æ–°æ¸²æŸ“é€‰ä¸­çš„æ ‡ç­¾ä»¥æ›´æ–°è¯­è¨€
    });

    function updateFormText() {
        // åˆ·æ–° placeholder
        const contentInput = document.getElementById("tweetContent");
        contentInput.placeholder = currentLang === 'cn' ?
            contentInput.getAttribute("placeholder") :
            contentInput.getAttribute("data-placeholder-en");

        const customTagInput = document.getElementById("customTag");
        customTagInput.placeholder = currentLang === 'cn' ?
            customTagInput.getAttribute("placeholder") :
            customTagInput.getAttribute("data-placeholder-en");

        // åˆ·æ–°æ–‡ä»¶é€‰ä¸­æç¤º
        const display = document.getElementById("fileNameDisplay");
        if (display.innerText) {
            const rawName = display.getAttribute('data-raw-name');
            if(rawName) {
                display.innerHTML = currentLang === 'cn' ?
                    `å·²é€‰æ‹©: ${rawName}` : `Selected: ${rawName}`;
            }
        }
    }

    function showFileName() {
        const fileInput = document.getElementById("paperFile");
        const display = document.getElementById("fileNameDisplay");
        if(fileInput.files.length > 0) {
            const fileName = fileInput.files[0].name;
            display.setAttribute('data-raw-name', fileName); // å­˜åŸå§‹åæ–¹ä¾¿åˆ‡æ¢è¯­è¨€
            display.innerHTML = currentLang === 'cn' ? `å·²é€‰æ‹©: ${fileName}` : `Selected: ${fileName}`;
        } else {
            display.innerHTML = "";
        }
    }

    // === æ ‡ç­¾é€‰æ‹©é€»è¾‘ ===
    document.querySelectorAll('.tag-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const tagVal = this.getAttribute('data-tag'); // å§‹ç»ˆè·å–ä¸­æ–‡å€¼
            if (selectedTags.has(tagVal)) {
                selectedTags.delete(tagVal);
                this.classList.remove('active');
            } else {
                selectedTags.add(tagVal);
                this.classList.add('active');
            }
            updateSelectedTags();
        });
    });

    // è‡ªå®šä¹‰æ ‡ç­¾è¾“å…¥
    document.getElementById('customTag').addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && this.value.trim() !== '') {
            e.preventDefault();
            const tag = this.value.trim();
            selectedTags.add(tag);
            this.value = '';
            updateSelectedTags();
        }
    });

    // æ¸²æŸ“â€œå·²é€‰æ ‡ç­¾â€ (æ”¯æŒåŒè¯­æ˜¾ç¤º)
    function updateSelectedTags() {
        const displayArea = document.getElementById('selectedTags');
        const hiddenInput = document.getElementById('finalTags');
        displayArea.innerHTML = '';

        // æ— è®ºå½“å‰è¯­è¨€æ˜¯å•¥ï¼Œä¼ ç»™åç«¯çš„ hiddenInput å§‹ç»ˆå­˜åŸå§‹å€¼ï¼ˆä¸­æ–‡ï¼‰ï¼Œä¿æŒæ•°æ®åº“ä¸€è‡´æ€§
        const tagsStr = Array.from(selectedTags).join(',');
        hiddenInput.value = tagsStr;

        selectedTags.forEach(tagVal => {
            // å°è¯•ç¿»è¯‘ï¼Œå¦‚æœæ˜¯è‡ªå®šä¹‰æ ‡ç­¾åˆ™æ˜¾ç¤ºåŸæ ·
            const displayCn = tagVal;
            const displayEn = tagTranslations[tagVal] || tagVal;

            const tagEl = document.createElement('div');
            tagEl.className = 'selected-tag-badge';

            // æ„å»ºåŒè¯­ HTML
            tagEl.innerHTML = `
                <span class="cn">${displayCn}</span>
                <span class="en">${displayEn}</span>
                <span class="btn-close-tag" data-tag="${tagVal}">âœ•</span>
            `;
            displayArea.appendChild(tagEl);

            // åˆ é™¤é€»è¾‘
            tagEl.querySelector('.btn-close-tag').addEventListener('click', function() {
                const delTag = this.getAttribute('data-tag');
                selectedTags.delete(delTag);

                // å–æ¶ˆæŒ‰é’®é«˜äº®
                document.querySelectorAll('.tag-btn').forEach(btn => {
                    if (btn.getAttribute('data-tag') === delTag) {
                        btn.classList.remove('active');
                    }
                });
                updateSelectedTags();
            });
        });

        // é‡æ–°åº”ç”¨è¯­è¨€æ˜¾éšè§„åˆ™ (å…³é”®æ­¥éª¤ï¼Œå¦åˆ™æ–°åŠ çš„å…ƒç´ ä¸éµå¾ªå½“å‰è¯­è¨€)
        if(typeof applyLang === 'function') applyLang(currentLang);
    }

    async function postTweet() {
        const content = document.getElementById("tweetContent").value;
        const fileInput = document.getElementById("paperFile");
        const tags = document.getElementById("finalTags").value;

        if (!content.trim()) {
            showToast(currentLang === 'cn' ? "è¯·å¡«å†™æè¿°å†…å®¹ï¼" : "Please fill in the description!");
            return;
        }

        const formData = new FormData();
        formData.append("content", content);
        formData.append("userId", userId);
        formData.append("tags", tags); // å‘é€ç»™åç«¯
        if (fileInput.files[0]) {
            formData.append("file", fileInput.files[0]);
        }

        try {
            const submitBtn = document.querySelector('.submit-btn');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = currentLang === 'cn' ? 'å‘å¸ƒä¸­...' : 'Publishing...';

            const response = await fetch('/api/tweets', {
                method: 'POST',
                body: formData
            });
            const result = await response.text();

            if (result.includes("æˆåŠŸ") || result.includes("success")) {
                showToast(currentLang === 'cn' ? "å‘å¸ƒæˆåŠŸï¼" : "Published successfully!", 'success');
                setTimeout(() => {
                    if(confirm(currentLang === 'cn' ? 'å‘å¸ƒæˆåŠŸï¼å»æŸ¥çœ‹ç®¡ç†é¡µå—ï¼Ÿ' : 'Published! Go to manage page?')) {
                        window.location.href = "content.html";
                    } else {
                        location.reload();
                    }
                }, 500);
            } else {
                showToast(currentLang === 'cn' ? "å‘å¸ƒå¤±è´¥: " + result : "Failed: " + result);
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        } catch (e) {
            showToast(currentLang === 'cn' ? "ç½‘ç»œé”™è¯¯" : "Network error");
            document.querySelector('.submit-btn').disabled = false;
        }
    }

    // åˆå§‹åŒ–
    updateFormText();
    // å¦‚æœæœ‰é¢„è®¾çš„ applyLangï¼Œç«‹å³æ‰§è¡Œä¸€æ¬¡ç¡®ä¿åˆå§‹çŠ¶æ€æ­£ç¡®
    if(typeof applyLang === 'function') applyLang(currentLang);
</script>
</body>
</html>