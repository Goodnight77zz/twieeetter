<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <!-- æ–°å¢ï¼šå“åº”å¼è§†å£æ ‡ç­¾ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>
        <span class="cn">æ–‡çŒ®è¯¦æƒ… & AI è¯„å®¡</span>
        <span class="en">Literature Details & AI Review</span>
    </title>
    <!-- å¼•å…¥é€šç”¨è¯­è¨€ç»„ä»¶CSS -->
    <link rel="stylesheet" href="common/lang-component.css">
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background-color: #f4f5f7; margin: 0; padding-top: 60px; height: 100vh; box-sizing: border-box; display: flex; flex-direction: column; }
        .navbar { position: fixed; top: 0; width: 100%; background: white; height: 60px; display: flex; align-items: center; padding: 0 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); z-index: 1000; justify-content: space-between; } /* æ–°å¢ï¼šjustify-content: space-between è®©è¿”å›æŒ‰é’®é å³ */
        .brand { color: #1da1f2; font-weight: 900; font-size: 24px; text-decoration: none; margin-right: 30px;}
        .back-link { color: #555; text-decoration: none; font-weight: bold; }

        .main-layout { display: flex; flex: 1; overflow: hidden; padding: 20px; gap: 20px; max-width: 1400px; margin: 0 auto; width: 100%; box-sizing: border-box; }

        /* å¢åŠ äº† padding-bottom ä»¥å®¹çº³è¯„è®ºåŒº */
        .left-panel { flex: 2; background: white; border-radius: 10px; padding: 30px; display: flex; flex-direction: column; box-shadow: 0 2px 8px rgba(0,0,0,0.05); overflow-y: auto; }
        .right-panel { flex: 1; background: white; border-radius: 10px; padding: 20px; display: flex; flex-direction: column; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-left: 5px solid #1da1f2; }

        .header { border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 15px; }
        .title-label { background: #eefaff; color: #00a1d6; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .meta-info { color: #777; font-size: 13px; margin-top: 8px; display: flex; gap: 10px; align-items: center; }
        .avatar { width: 24px; height: 24px; border-radius: 50%; object-fit: cover;}

        .content-body { font-size: 15px; line-height: 1.6; color: #333; white-space: pre-wrap; margin-bottom: 20px; }

        /* === æ–°å¢ï¼šäº’åŠ¨åŒºåŸŸæ ·å¼ === */
        .interaction-bar { margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px; display: flex; align-items: center; gap: 20px; }
        .btn-like {
            display: flex; align-items: center; gap: 5px; cursor: pointer;
            color: #536471; font-size: 14px; transition: 0.2s; border: none; background: none;
        }
        .btn-like:hover { color: #f91880; }
        .btn-like.liked { color: #f91880; font-weight: bold; }
        .btn-like svg { width: 20px; height: 20px; fill: currentColor; }

        /* è¯„è®ºåŒºæ ·å¼ */
        .comment-section { margin-top: 30px; }
        .comment-title { font-weight: bold; font-size: 16px; margin-bottom: 15px; color: #0f1419; }

        .comment-input-box { display: flex; gap: 10px; margin-bottom: 20px; }
        .comment-input {
            flex: 1; padding: 10px; border: 1px solid #cfd9de; border-radius: 20px;
            outline: none; font-size: 14px; transition: 0.2s;
        }
        .comment-input:focus { border-color: #1da1f2; background: #f8fbff; }
        .btn-submit {
            background: #1da1f2; color: white; border: none; padding: 0 20px;
            border-radius: 20px; font-weight: bold; cursor: pointer;
        }
        .btn-submit:hover { background: #0d8ddb; }

        .comment-list { display: flex; flex-direction: column; gap: 15px; }
        .comment-item { display: flex; gap: 10px; font-size: 14px; }
        .c-avatar { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; }
        .c-content { background: #f7f9f9; padding: 10px 15px; border-radius: 0 12px 12px 12px; flex: 1; }
        .c-name { font-weight: bold; color: #0f1419; margin-right: 5px; cursor: pointer;}
        .c-time { color: #536471; font-size: 12px; }
        .c-text { margin-top: 5px; color: #333; line-height: 1.4; }

        /* å³ä¾§ AI æ ·å¼ä¿æŒä¸å˜ */
        .ai-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .ai-btn { background: linear-gradient(90deg, #6366f1, #8b5cf6); color: white; border: none; padding: 8px 20px; border-radius: 20px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 10px rgba(99, 102, 241, 0.3); transition: 0.2s; }
        .ai-btn:hover { transform: scale(1.05); }
        .ai-btn:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }
        .ai-result-box { flex: 1; background: #f8fafc; border-radius: 8px; padding: 15px; overflow-y: auto; font-size: 14px; line-height: 1.6; color: #334155; border: 1px dashed #cbd5e1; }
        .loader { display: none; text-align: center; margin-top: 20px; }
        .spinner { width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #6366f1; border-radius: 50%; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        iframe { width: 100%; height: 600px; border: 1px solid #eee; border-radius: 4px; }
        .file-card { background: #f8f9fa; border: 1px solid #e1e4e8; border-radius: 8px; padding: 30px; text-align: center; margin-top: 10px; }
        .file-icon { font-size: 48px; margin-bottom: 10px; display: block; }
        .file-name { font-weight: bold; color: #333; font-size: 16px; }
        .file-tip { color: #666; font-size: 13px; margin: 10px 0 20px 0; }
        .download-btn { background: #0f1419; color: white; text-decoration: none; padding: 10px 25px; border-radius: 20px; font-weight: bold; font-size: 14px; display: inline-block; transition: 0.2s; }
        .download-btn:hover { background: #333; }

        /* ========== æ–°å¢ï¼šå“åº”å¼åª’ä½“æŸ¥è¯¢ ========== */
        /* å¹³æ¿/æ‰‹æœºæ¨ªå±ï¼ˆâ‰¤992pxï¼‰ */
        @media (max-width: 992px) {
            .main-layout {
                flex-direction: column; /* æ¨ªæ’å˜ç«–æ’ */
                gap: 15px;
                padding: 15px;
            }
            .left-panel, .right-panel {
                flex: none; /* å–æ¶ˆå¼¹æ€§å æ¯”ï¼Œè‡ªé€‚åº”é«˜åº¦ */
                width: 100%;
                padding: 20px;
            }
            iframe {
                height: 400px; /* é™ä½iframeé«˜åº¦ï¼Œé€‚é…å¹³æ¿ */
            }
        }

        /* æ‰‹æœºç«–å±ï¼ˆâ‰¤576pxï¼‰ */
        @media (max-width: 576px) {
            .navbar {
                padding: 0 10px;
            }
            .brand {
                font-size: 20px; /* ç¼©å°å“ç‰Œåå­—å· */
                margin-right: 10px;
            }
            .main-layout {
                padding: 10px;
                gap: 10px;
            }
            .left-panel {
                padding: 15px;
            }
            .right-panel {
                padding: 15px;
            }
            iframe {
                height: 300px; /* è¿›ä¸€æ­¥é™ä½iframeé«˜åº¦ï¼Œé€‚é…æ‰‹æœº */
            }
            /* è¯„è®ºåŒºé€‚é…ï¼šè¾“å…¥æ¡†åŠ é«˜ã€æŒ‰é’®å æ»¡å®½åº¦ */
            .comment-input-box {
                flex-direction: column; /* è¾“å…¥æ¡†å’ŒæŒ‰é’®ç«–æ’ */
                gap: 8px;
            }
            .comment-input {
                min-height: 90px;
                font-size: 16px;
                padding: 12px;
                border-radius: 12px;
            }
            .btn-submit {
                width: 100%;
                padding: 12px;
                font-size: 16px;
                border-radius: 12px;
            }
            /* è¯„è®ºé¡¹ï¼šåŠ å¤§é—´è·ï¼Œå¤´åƒæ”¾å¤§ */
            .comment-item {
                gap: 12px;
            }
            .c-avatar {
                width: 40px;
                height: 40px;
            }
            .c-content {
                padding: 12px 15px;
                font-size: 15px;
            }
            .c-text {
                line-height: 1.6;
            }
            /* AIæŒ‰é’®å æ»¡å®½åº¦ï¼Œæ–¹ä¾¿ç‚¹å‡» */
            .ai-btn {
                width: 100%;
                padding: 10px;
            }
            .ai-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            /* æ–‡ä»¶å¡ç‰‡é€‚é…ï¼šç¼©å°å†…è¾¹è· */
            .file-card {
                padding: 20px 10px;
            }
            .file-icon {
                font-size: 40px;
            }
            .file-name {
                font-size: 15px;
            }
            .download-btn {
                padding: 8px 20px;
                font-size: 13px;
            }
            /* éšè—PCç«¯è¯­è¨€é€‰æ‹©å™¨ï¼Œæ˜¾ç¤ºç§»åŠ¨ç«¯ä¸‹æ‹‰ */
            .lang-selector {
                display: none !important; /* éšè—åŸæœ‰æ‹–æ‹½è¯­è¨€é€‰æ‹©å™¨ */
            }
            .lang-selector-mobile {
                display: block; /* æ˜¾ç¤ºç§»åŠ¨ç«¯ä¸‹æ‹‰èœå• */
                width: 100%;
                padding: 10px;
                margin: 10px 0;
                border: 1px solid #cfd9de;
                border-radius: 8px;
                font-size: 16px;
                background: white;
            }
        }

        /* ç§»åŠ¨ç«¯è¯­è¨€é€‰æ‹©å™¨é»˜è®¤éšè—ï¼ˆä»…æ‰‹æœºç«¯æ˜¾ç¤ºï¼‰ */
        .lang-selector-mobile {
            display: none;
        }
    </style>
</head>
<body>

<div class="navbar">
    <div style="display:flex; align-items:center;">
        <a href="index.html" class="brand">Twieeetter</a>
        <span style="color:#999; font-size:14px;">
            <span class="cn">| æ™ºèƒ½ç§‘ç ”å¹³å°</span>
            <span class="en">| Intelligent Research Platform</span>
        </span>
    </div>
    <a href="javascript:history.back()" class="back-link">â¬…
        <span class="cn">è¿”å›</span>
        <span class="en">Back</span>
    </a>
</div>

<div class="main-layout">
    <!-- å·¦ä¾§ -->
    <div class="left-panel">
        <!-- æ–°å¢ï¼šç§»åŠ¨ç«¯è¯­è¨€é€‰æ‹©å™¨ï¼ˆä»…æ‰‹æœºç«¯æ˜¾ç¤ºï¼‰ -->
        <select class="lang-selector-mobile" id="langMobile">
            <option value="cn">ä¸­æ–‡</option>
            <option value="en">English</option>
        </select>

        <div class="header">
            <span class="title-label">
                <span class="cn">ç ”ç©¶æˆæœ</span>
                <span class="en">Research Achievement</span>
            </span>
            <div class="meta-info">
                <img id="authorAvatar" src="" class="avatar">
                <span id="authorName">
                    <span class="cn">ä½œè€…...</span>
                    <span class="en">Author...</span>
                </span>
                <span id="publishTime">
                    <span class="cn">æ—¶é—´...</span>
                    <span class="en">Time...</span>
                </span>
            </div>
        </div>
        <div class="content-body" id="mainContent">
            <span class="cn">åŠ è½½ä¸­...</span>
            <span class="en">Loading...</span>
        </div>

        <h4 style="margin-bottom:10px;">
            <span class="cn">ğŸ“„ é™„ä»¶å†…å®¹</span>
            <span class="en">ğŸ“„ Attachment Content</span>
        </h4>
        <iframe id="pdfViewer" src="" style="display:none;"></iframe>
        <div id="docCard" class="file-card" style="display: none;">
            <span class="file-icon">ğŸ“</span>
            <div class="file-name" id="docName">filename.doc</div>
            <div class="file-tip">
                <span class="cn">è¯¥æ–‡ä»¶æ ¼å¼æš‚ä¸æ”¯æŒåœ¨çº¿é¢„è§ˆï¼Œä½† AI ä»å¯è¯»å–å†…å®¹ã€‚</span>
                <span class="en">This file format does not support online preview, but AI can still read the content.</span>
            </div>
            <a href="#" id="docDownload" class="download-btn" target="_blank">
                <span class="cn">â¬‡ï¸ ä¸‹è½½æ–‡ä»¶</span>
                <span class="en">â¬‡ï¸ Download File</span>
            </a>
        </div>
        <div id="noFileTip" style="display:none; color:#999; padding:20px; text-align:center; background:#fafafa;">
            <span class="cn">æ— é™„ä»¶æ–‡æ¡£</span>
            <span class="en">No Attachment Documents</span>
        </div>

        <!-- === æ–°å¢ï¼šäº’åŠ¨æ  (ç‚¹èµ) === -->
        <div class="interaction-bar">
            <button id="likeBtn" class="btn-like" onclick="toggleLike()">
                <!-- çˆ±å¿ƒ SVG å›¾æ ‡ -->
                <svg viewBox="0 0 24 24"><path d="M16.697 5.5c-1.222-.06-2.679.51-3.89 2.16l-.805 1.09-.806-1.09C9.984 6.01 8.526 5.44 7.304 5.5c-1.243.07-2.349.78-2.91 1.91-.552 1.12-.633 2.78.479 4.82 1.074 1.97 3.257 4.27 7.129 6.61 3.87-2.34 6.052-4.64 7.126-6.61 1.111-2.04 1.03-3.7.477-4.82-.561-1.13-1.666-1.84-2.908-1.91zm4.187 7.69c-1.351 2.48-4.001 5.12-8.379 7.67l-.503.3-.504-.3c-4.379-2.55-7.029-5.19-8.382-7.67-1.36-2.5-1.41-4.86-.514-6.67.887-1.79 2.647-2.91 4.601-3.01 1.651-.09 3.368.56 4.798 2.01 1.429-1.45 3.146-2.1 4.796-2.01 1.954.1 3.714 1.22 4.601 3.01.896 1.81.846 4.17-.514 6.67z"></path></svg>
                <span id="likeCount">0</span>
            </button>
        </div>

        <!-- === æ–°å¢ï¼šè¯„è®ºåŒº === -->
        <div class="comment-section">
            <div class="comment-title">
                <span class="cn">è¯„è®º</span>
                <span class="en">Comments</span>
            </div>
            <div class="comment-input-box">
                <input type="text" id="commentInput" class="comment-input" placeholder="å†™ä¸‹ä½ çš„çœ‹æ³•..." data-placeholder-en="Share your thoughts...">
                <button class="btn-submit" onclick="submitComment()">
                    <span class="cn">å‘é€</span>
                    <span class="en">Send</span>
                </button>
            </div>
            <div id="commentList" class="comment-list">
                <!-- è¯„è®ºåŠ è½½åœ¨è¿™é‡Œ -->
            </div>
        </div>
    </div>

    <!-- å³ä¾§ -->
    <div class="right-panel">
        <div class="ai-header">
            <h3 style="margin:0; color:#1e293b;">ğŸ¤–
                <span class="cn">AI æ™ºèƒ½è¯„å®¡</span>
                <span class="en">AI Intelligent Review</span>
            </h3>
            <button id="aiBtn" class="ai-btn" onclick="startAiReview()">
                <span class="cn">âœ¨ å¼€å§‹è¯„ä¼°</span>
                <span class="en">âœ¨ Start Evaluation</span>
            </button>
        </div>
        <div class="ai-result-box" id="aiOutput">
            <p style="color:#94a3b8; text-align:center; margin-top:50px;">
                <span class="cn">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ï¼Œ<br>AI å°†è‡ªåŠ¨é˜…è¯»å·¦ä¾§è®ºæ–‡å¹¶ç”Ÿæˆè¯„å®¡æŠ¥å‘Šã€‚</span>
                <span class="en">Click the button above,<br>AI will automatically read the paper and generate a review report.</span>
            </p>
            <div class="loader" id="loader">
                <div class="spinner"></div>
                <div style="margin-top:10px; color:#6366f1;">
                    <span class="cn">AI æ­£åœ¨é˜…è¯»è®ºæ–‡å¹¶æ€è€ƒä¸­...<br>(æœ¬åœ°æ¨¡å‹é€Ÿåº¦å–å†³äºç”µè„‘é…ç½®)</span>
                    <span class="en">AI is reading the paper and thinking...<br>(Local model speed depends on computer configuration)</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- é€šç”¨è¯­è¨€åˆ‡æ¢ç»„ä»¶HTMLï¼ˆPCç«¯ç”¨ï¼Œæ‰‹æœºç«¯éšè—ï¼‰ -->
<div class="lang-selector" id="langSelector">
    <button class="lang-trigger" id="langTrigger">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 21l5.25-11.25L21 21m-9-3h7.5M3 10.5h7.5M13.5 3H3v7.5" />
        </svg>
    </button>
    <div class="lang-dropdown">
        <button class="lang-option" id="langCn" onclick="switchLang('cn')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
            </svg>
            ä¸­æ–‡
        </button>
        <button class="lang-option" id="langEn" onclick="switchLang('en')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
            </svg>
            English
        </button>
    </div>
</div>

<!-- å¼•å…¥é€šç”¨è¯­è¨€ç»„ä»¶JS -->
<script src="common/lang-component.js"></script>

<script>
    const params = new URLSearchParams(window.location.search);
    const tweetId = params.get("id");
    const currentUserId = localStorage.getItem("userId");
    // å½“å‰è¯­è¨€çŠ¶æ€
    let currentLang = localStorage.getItem('appLang') || 'cn';

    // æ–°å¢ï¼šç§»åŠ¨ç«¯è¯­è¨€é€‰æ‹©å™¨é€»è¾‘
    const langMobile = document.getElementById('langMobile');
    // åˆå§‹åŒ–ï¼šåŒæ­¥æœ¬åœ°å­˜å‚¨çš„è¯­è¨€
    window.onload = function() {
        const savedLang = localStorage.getItem('appLang') || 'cn';
        langMobile.value = savedLang;
    };
    // ç»‘å®šä¸‹æ‹‰èœå•åˆ‡æ¢äº‹ä»¶
    langMobile.addEventListener('change', (e) => {
        switchLang(e.target.value); // å¤ç”¨åŸæœ‰åˆ‡æ¢é€»è¾‘
        localStorage.setItem('appLang', e.target.value); // ä¿å­˜åˆ°æœ¬åœ°
        // è§¦å‘è¯­è¨€åˆ‡æ¢äº‹ä»¶ï¼Œæ›´æ–°é¡µé¢æ–‡æœ¬
        window.dispatchEvent(new Event('languageChange'));
    });

    // ç›‘å¬è¯­è¨€åˆ‡æ¢äº‹ä»¶ï¼Œæ›´æ–°é¡µé¢æ–‡æœ¬
    window.addEventListener('languageChange', function() {
        currentLang = localStorage.getItem('appLang') || 'cn';
        // åˆ·æ–°è¯„è®ºåŒºå’Œç›¸å…³é™æ€æ–‡æœ¬
        updateStaticText();
        loadComments();
        // åŒæ­¥ä¸‹æ‹‰èœå•é€‰ä¸­çŠ¶æ€
        langMobile.value = currentLang;
    });

    // æ›´æ–°é¡µé¢é™æ€æ–‡æœ¬ï¼ˆè¯­è¨€åˆ‡æ¢æ—¶è°ƒç”¨ï¼‰
    function updateStaticText() {
        const noFileTip = document.getElementById("noFileTip");
        noFileTip.innerHTML = `
            <span class="cn">æ— é™„ä»¶æ–‡æ¡£</span>
            <span class="en">No Attachment Documents</span>
        `;

        const docCardTip = document.querySelector('.file-tip');
        if (docCardTip) {
            docCardTip.innerHTML = `
                <span class="cn">è¯¥æ–‡ä»¶æ ¼å¼æš‚ä¸æ”¯æŒåœ¨çº¿é¢„è§ˆï¼Œä½† AI ä»å¯è¯»å–å†…å®¹ã€‚</span>
                <span class="en">This file format does not support online preview, but AI can still read the content.</span>
            `;
        }

        const downloadBtn = document.getElementById("docDownload");
        if (downloadBtn) {
            downloadBtn.innerHTML = `
                <span class="cn">â¬‡ï¸ ä¸‹è½½æ–‡ä»¶</span>
                <span class="en">â¬‡ï¸ Download File</span>
            `;
        }

        const aiBtn = document.getElementById("aiBtn");
        if (aiBtn && aiBtn.innerText.includes("è¯„ä¼°")) {
            aiBtn.innerHTML = `
                <span class="cn">âœ¨ å¼€å§‹è¯„ä¼°</span>
                <span class="en">âœ¨ Start Evaluation</span>
            `;
        } else if (aiBtn && aiBtn.innerText.includes("åˆ†æä¸­")) {
            aiBtn.innerHTML = `
                <span class="cn">åˆ†æä¸­...</span>
                <span class="en">Analyzing...</span>
            `;
        } else if (aiBtn && aiBtn.innerText.includes("æ— æ–‡ä»¶")) {
            aiBtn.innerHTML = `
                <span class="cn">æ— æ–‡ä»¶å¯åˆ†æ</span>
                <span class="en">No File to Analyze</span>
            `;
        } else if (aiBtn && aiBtn.innerText.includes("é‡è¯•")) {
            aiBtn.innerHTML = `
                <span class="cn">âœ¨ é‡è¯•è¯„ä¼°</span>
                <span class="en">âœ¨ Retry Evaluation</span>
            `;
        }

        // åŒæ­¥è¯„è®ºè¾“å…¥æ¡†å ä½ç¬¦
        const commentInput = document.getElementById('commentInput');
        commentInput.placeholder = currentLang === 'cn' ? 'å†™ä¸‹ä½ çš„çœ‹æ³•...' : 'Share your thoughts...';
    }

    // 1. åŠ è½½è¯¦æƒ…
    async function loadDetail() {
        try {
            const res = await fetch(`/api/tweets/${tweetId}`);
            if(!res.ok) throw new Error(currentLang === 'cn' ? "æœªæ‰¾åˆ°" : "Not found");
            const data = await res.json();

            const user = data.author;
            document.getElementById("authorName").innerText = user.nickname || user.username;
            document.getElementById("authorAvatar").src = user.avatar ? `/uploads/${user.avatar}` : 'https://via.placeholder.com/30';
            document.getElementById("publishTime").innerText = data.createTime.replace('T', ' ').split('.')[0];
            document.getElementById("mainContent").innerText = data.content;

            if(data.filePath && data.originalFilename) {
                const pathParts = data.filePath.split(/[\\/]/);
                const realFileName = pathParts[pathParts.length - 1];
                const fileUrl = `/uploads/${realFileName}`;
                const lowerName = data.originalFilename.toLowerCase();

                if (lowerName.endsWith(".pdf")) {
                    const viewer = document.getElementById("pdfViewer");
                    viewer.src = fileUrl;
                    viewer.style.display = "block";
                } else {
                    const card = document.getElementById("docCard");
                    card.style.display = "block";
                    document.getElementById("docName").innerText = data.originalFilename;
                    document.getElementById("docDownload").href = fileUrl;
                    document.getElementById("pdfViewer").style.display = "none";
                    document.getElementById("pdfViewer").src = "";
                }
            } else {
                document.getElementById("noFileTip").style.display = "block";
                document.getElementById("aiBtn").disabled = true;
                document.getElementById("aiBtn").innerHTML = `
                    <span class="cn">æ— æ–‡ä»¶å¯åˆ†æ</span>
                    <span class="en">No File to Analyze</span>
                `;
            }

            // åŠ è½½å®Œè¯¦æƒ…åï¼ŒåŠ è½½ç‚¹èµçŠ¶æ€å’Œè¯„è®ºï¼Œæ›´æ–°é™æ€æ–‡æœ¬
            loadLikeStatus();
            loadComments();
            updateStaticText();

        } catch (e) {
            console.error(e);
            alert(`${currentLang === 'cn' ? "åŠ è½½å¤±è´¥: " : "Loading failed: "}${e.message}`);
        }
    }

    // 2. åŠ è½½ç‚¹èµçŠ¶æ€
    async function loadLikeStatus() {
        const res = await fetch(`/api/tweets/${tweetId}/like-status?userId=${currentUserId}`);
        const data = await res.json();

        const btn = document.getElementById("likeBtn");
        document.getElementById("likeCount").innerText = data.count;

        if (data.isLiked) {
            btn.classList.add("liked");
            // æ¢æˆå®å¿ƒçˆ±å¿ƒå›¾æ ‡
            btn.querySelector("svg").innerHTML = `<path d="M20.884 13.19c-1.351 2.48-4.001 5.12-8.379 7.67l-.503.3-.504-.3c-4.379-2.55-7.029-5.19-8.382-7.67-1.36-2.5-1.41-4.86-.514-6.67.887-1.79 2.647-2.91 4.601-3.01 1.651-.09 3.368.56 4.798 2.01 1.429-1.45 3.146-2.1 4.796-2.01 1.954.1 3.714 1.22 4.601 3.01.896 1.81.846 4.17-.514 6.67z"></path>`;
        } else {
            btn.classList.remove("liked");
            // æ¢å›ç©ºå¿ƒçˆ±å¿ƒ
            btn.querySelector("svg").innerHTML = `<path d="M16.697 5.5c-1.222-.06-2.679.51-3.89 2.16l-.805 1.09-.806-1.09C9.984 6.01 8.526 5.44 7.304 5.5c-1.243.07-2.349.78-2.91 1.91-.552 1.12-.633 2.78.479 4.82 1.074 1.97 3.257 4.27 7.129 6.61 3.87-2.34 6.052-4.64 7.126-6.61 1.111-2.04 1.03-3.7.477-4.82-.561-1.13-1.666-1.84-2.908-1.91zm4.187 7.69c-1.351 2.48-4.001 5.12-8.379 7.67l-.503.3-.504-.3c-4.379-2.55-7.029-5.19-8.382-7.67-1.36-2.5-1.41-4.86-.514-6.67.887-1.79 2.647-2.91 4.601-3.01 1.651-.09 3.368.56 4.798 2.01 1.429-1.45 3.146-2.1 4.796-2.01 1.954.1 3.714 1.22 4.601 3.01.896 1.81.846 4.17-.514 6.67z"></path>`;
        }
    }

    // 3. ç‚¹èµæ“ä½œ
    async function toggleLike() {
        const res = await fetch(`/api/tweets/${tweetId}/like?userId=${currentUserId}`, { method: 'POST' });
        const msg = await res.text();
        const successText = currentLang === 'cn' ? 'æˆåŠŸ' : 'success';
        const cancelText = currentLang === 'cn' ? 'å–æ¶ˆ' : 'cancel';
        if(msg.includes(successText) || msg.includes(cancelText)) {
            loadLikeStatus(); // åˆ·æ–°çŠ¶æ€
        }
    }

    // 4. åŠ è½½è¯„è®ºåˆ—è¡¨
    async function loadComments() {
        const res = await fetch(`/api/tweets/${tweetId}/comments`);
        const list = await res.json();
        const container = document.getElementById("commentList");
        container.innerHTML = "";

        const noCommentText = currentLang === 'cn' ? 'æš‚æ— è¯„è®ºï¼Œå¿«æ¥æŠ¢æ²™å‘~' : 'No comments yet, be the first to comment!';

        if(list.length === 0) {
            container.innerHTML = `<div style='color:#999; font-size:13px;'>${noCommentText}</div>`;
            return;
        }

        list.forEach(c => {
            const avatar = c.user.avatar ? `/uploads/${c.user.avatar}` : 'https://via.placeholder.com/36';
            const time = c.createTime.replace('T', ' ').split('.')[0];
            const name = c.user.nickname || c.user.username;

            container.innerHTML += `
                <div class="comment-item">
                    <img src="${avatar}" class="c-avatar" onclick="location.href='user_profile.html?id=${c.user.id}'" style="cursor:pointer">
                    <div class="c-content">
                        <div style="display:flex; align-items:center; justify-content:space-between;">
                            <span class="c-name" onclick="location.href='user_profile.html?id=${c.user.id}'">${name}</span>
                            <span class="c-time">${time}</span>
                        </div>
                        <div class="c-text">${c.content}</div>
                    </div>
                </div>
            `;
        });
    }

    // 5. å‘é€è¯„è®º
    async function submitComment() {
        const content = document.getElementById("commentInput").value;
        const emptyTip = currentLang === 'cn' ? 'è¯„è®ºä¸èƒ½ä¸ºç©º' : 'Comment cannot be empty';
        if(!content.trim()) { alert(emptyTip); return; }

        const formData = new FormData();
        formData.append("userId", currentUserId);
        formData.append("content", content);

        const res = await fetch(`/api/tweets/${tweetId}/comments`, { method: 'POST', body: formData });
        const msg = await res.text();
        const successText = currentLang === 'cn' ? 'æˆåŠŸ' : 'success';
        if(msg.includes(successText)) {
            document.getElementById("commentInput").value = ""; // æ¸…ç©ºè¾“å…¥æ¡†
            loadComments(); // åˆ·æ–°åˆ—è¡¨
        } else {
            alert(msg);
        }
    }

    // AI è¯„å®¡åŒè¯­è¨€é€‚é…
    async function startAiReview() {
        const btn = document.getElementById("aiBtn");
        const output = document.getElementById("aiOutput");
        const loader = document.getElementById("loader");
        btn.disabled = true;
        btn.innerHTML = `
            <span class="cn">åˆ†æä¸­...</span>
            <span class="en">Analyzing...</span>
        `;
        output.innerHTML = "";
        output.appendChild(loader);
        loader.style.display = "block";

        try {
            const res = await fetch(`/api/ai/evaluate/${tweetId}`, { method: 'POST' });
            const data = await res.json();
            let formatted = data.result.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            output.innerHTML = `
                <div style="color:#333; font-weight:bold; margin-bottom:10px;">
                    <span class="cn">åˆ†æå®Œæˆï¼š</span>
                    <span class="en">Analysis Completedï¼š</span>
                </div>
                <div style="line-height:1.8;">${formatted}</div>
            `;
        } catch (e) {
            output.innerHTML = `
                <div style="color:red;">
                    <span class="cn">åˆ†æå‡ºé”™: </span>
                    <span class="en">Analysis Error: </span>${e.message}
                </div>
            `;
            btn.disabled = false;
            btn.innerHTML = `
                <span class="cn">âœ¨ é‡è¯•è¯„ä¼°</span>
                <span class="en">âœ¨ Retry Evaluation</span>
            `;
        }
    }

    loadDetail();
</script>
</body>
</html>