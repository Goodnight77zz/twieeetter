<!DOCTYPE html>
<!-- é»˜è®¤è®¾ç½® lang="zh"ï¼ŒCSS ä¼šæ ¹æ®è¿™ä¸ªå±æ€§è‡ªåŠ¨æ§åˆ¶æ˜¾éš -->
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        <span class="cn">Twieeetter - å­¦æœ¯äº¤æµå¹³å°</span>
        <span class="en">Twieeetter - Academic Plaza</span>
    </title>
    <!-- å¼•å…¥é€šç”¨è¯­è¨€ç»„ä»¶CSS -->
    <link rel="stylesheet" href="common/lang-component.css">
    <!-- å¼•å…¥å›¾æ ‡åº“ -->
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background-color: #f0f2f5; margin: 0; padding-top: 70px; }

        /* é¡¶éƒ¨å¯¼èˆªæ  */
        .navbar {
            position: fixed; top: 0; width: 100%; background: white; height: 64px;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.08); z-index: 1000; box-sizing: border-box;
        }

        .nav-left { display: flex; align-items: center; gap: 20px; }
        .brand { font-size: 24px; font-weight: 900; color: #1da1f2; text-decoration: none; display: flex; align-items: center; gap: 5px; }

        /* åˆ›ä½œä¸­å¿ƒæŒ‰é’® */
        .btn-create {
            background: linear-gradient(90deg, #00a1d6, #00b5e5);
            color: white; padding: 8px 20px; border-radius: 20px;
            text-decoration: none; font-weight: bold; font-size: 14px;
            display: flex; align-items: center; gap: 5px; transition: transform 0.2s;
        }
        .btn-create:hover { transform: scale(1.05); }

        .nav-right { display: flex; align-items: center; gap: 25px; }

        /* å¯¼èˆªé“¾æ¥æ ·å¼ */
        .nav-item {
            text-decoration: none; color: #555; font-weight: 600; font-size: 15px;
            display: flex; align-items: center; gap: 6px; transition: color 0.2s;
        }
        .nav-item:hover { color: #1da1f2; }

        /* ç”¨æˆ·ä¿¡æ¯ */
        .user-info { display: flex; align-items: center; gap: 8px; cursor: pointer; }
        .avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 1px solid #eee; }
        .username { font-weight: bold; color: #333; }

        /* é€€å‡ºæŒ‰é’® */
        .btn-logout {
            border: 1px solid #ff4d4f; color: #ff4d4f; background: white;
            padding: 5px 15px; border-radius: 4px; cursor: pointer; font-size: 13px;
            transition: all 0.2s;
        }
        .btn-logout:hover { background: #fff1f0; }

        /* ä¸»å†…å®¹åŒº */
        .container { max-width: 700px; margin: 20px auto; padding-bottom: 40px; }

        /* æ¨æ–‡å¡ç‰‡ */
        .tweet-card {
            background: white; border-radius: 12px; padding: 20px;
            margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s; cursor: pointer; position: relative;
        }
        .tweet-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }

        .card-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .author-box { display: flex; gap: 12px; }
        .author-avatar { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; }
        .author-name { font-weight: bold; font-size: 16px; color: #0f1419; }
        .author-handle { color: #536471; font-size: 14px; }
        .time-label { color: #536471; font-size: 13px; }

        .card-content { font-size: 16px; line-height: 1.6; color: #0f1419; margin-bottom: 15px; white-space: pre-wrap; }

        /* é™„ä»¶å±•ç¤º */
        .file-box {
            background: #f7f9f9; border: 1px solid #cfd9de; border-radius: 12px;
            padding: 12px; display: flex; align-items: center; gap: 12px; margin-top: 10px;
        }
        .file-icon { font-size: 24px; color: #536471; background: #eff3f4; padding: 8px; border-radius: 8px; }
        .file-info { display: flex; flex-direction: column; overflow: hidden; }
        .file-name { font-weight: bold; color: #1da1f2; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .file-label { font-size: 12px; color: #536471; }

        /* åº•éƒ¨æ“ä½œæ  */
        .card-footer { display: flex; gap: 20px; margin-top: 15px; border-top: 1px solid #eff3f4; padding-top: 10px; color: #536471; font-size: 14px; }
        .action-item { display: flex; align-items: center; gap: 5px; }

        /* æ ‡ç­¾æ ·å¼ */
        .tag-badge {
            display: inline-block; padding: 2px 8px; border-radius: 12px;
            background: #e8f5fe; color: #1da1f2; font-size: 12px; margin-top: 8px; margin-right: 5px;
        }

        /* æ‰‹æœºç«¯é€‚é… */
        @media (max-width: 600px) {
            .nav-item span { display: none; } /* æ‰‹æœºç«¯éšè—å¯¼èˆªæ–‡å­—åªç•™å›¾æ ‡ */
            .btn-create span { display: none; }
            .navbar { padding: 0 10px; }
        }
    </style>
</head>
<body>

<!-- é¡¶éƒ¨å¯¼èˆªæ  -->
<div class="navbar">
    <div class="nav-left">
        <a href="index.html" class="brand">
            Twieeetter ğŸ“
        </a>
        <a href="dashboard.html" class="btn-create">
            <i class="fas fa-bolt"></i>
            <span class="cn">è¿›å…¥åˆ›ä½œä¸­å¿ƒ</span>
            <span class="en">Creator Center</span>
        </a>
    </div>

    <div class="nav-right">
        <a href="search.html" class="nav-item">
            <i class="fas fa-search"></i>
            <span class="cn">æœç´¢</span>
            <span class="en">Search</span>
        </a>

        <a href="friends.html" class="nav-item">
            <i class="fas fa-users"></i>
            <span class="cn">å¥½å‹åˆ—è¡¨</span>
            <span class="en">Friends</span>
        </a>

        <!-- ç”¨æˆ·ä¿¡æ¯ -->
        <div class="user-info" onclick="goToMyProfile()">
            <img id="navAvatar" src="https://via.placeholder.com/32" class="avatar">
            <span id="navUsername" class="username">User</span>
        </div>

        <button onclick="logout()" class="btn-logout">
            <span class="cn">é€€å‡º</span>
            <span class="en">Logout</span>
        </button>
    </div>
</div>

<!-- ä¸»å†…å®¹ï¼šæ¨æ–‡æµ -->
<div class="container" id="feedContainer">
    <div style="text-align: center; padding: 40px; color: #999;">
        <span class="cn">åŠ è½½ä¸­...</span>
        <span class="en">Loading...</span>
    </div>
</div>

<!-- è¯­è¨€åˆ‡æ¢æ‚¬æµ®çƒ (ä½¿ç”¨æ–°çš„ switchLang å‚æ•°) -->
<div class="lang-selector" id="langSelector">
    <button class="lang-trigger" id="langTrigger">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 21l5.25-11.25L21 21m-9-3h7.5M3 10.5h7.5M13.5 3H3v7.5" />
        </svg>
    </button>
    <div class="lang-dropdown">
        <button class="lang-option" onclick="switchLang('zh')">ä¸­æ–‡</button>
        <button class="lang-option" onclick="switchLang('en')">English</button>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="common/lang-component.js"></script>

<script>
    // æ ‡ç­¾ç¿»è¯‘å­—å…¸ (åŒæ­¥ profile é‡Œçš„é€»è¾‘)
    const tagTranslations = {
        "AI": "AI",
        "ç”Ÿç‰©åŒ»å­¦": "Biomedical",
        "è®¡ç®—æœº": "Comp Sci",
        "ç‰©ç†": "Physics",
        "åŒ–å­¦": "Chemistry",
        "æ·±åº¦å­¦ä¹ ": "Deep Learning",
        "æ•°æ®åˆ†æ": "Data Analysis"
    };

    const currentUserId = localStorage.getItem("userId");
    if(!currentUserId) window.location.href = "login.html";

    // ğŸ”¥ å…¨å±€å˜é‡ç¼“å­˜æ•°æ®ï¼Œé˜²æ­¢åˆ‡æ¢è¯­è¨€æ—¶é‡æ–°è¯·æ±‚ç½‘ç»œ
    let globalTweets = [];

    // åˆå§‹åŒ–åŠ è½½
    loadUserInfo();
    fetchFeed(); // ç¬¬ä¸€æ¬¡ä»ç½‘ç»œè·å–

    // ç›‘å¬è¯­è¨€åˆ‡æ¢äº‹ä»¶ (ç”± lang-component.js è§¦å‘)
    window.addEventListener('languageChange', function() {
        // è¯­è¨€åˆ‡æ¢æ—¶ï¼Œç›´æ¥åˆ©ç”¨ç¼“å­˜æ•°æ®é‡æ–°ç”Ÿæˆ HTML
        // è¿™æ ·æ—¶é—´æ ¼å¼ä¼šå˜ï¼Œè€Œä¸”æ–°ç”Ÿæˆçš„ HTML ä¼šç«‹å³éµå¾ª CSS çš„æ˜¾éšè§„åˆ™
        renderFeed();
    });

    async function loadUserInfo() {
        const username = localStorage.getItem("username");
        document.getElementById("navUsername").innerText = username;
        try {
            const res = await fetch(`/api/users/${currentUserId}`);
            const user = await res.json();
            if(user.avatar) {
                document.getElementById("navAvatar").src = "/uploads/" + user.avatar;
            }
        } catch(e) {}
    }

    function goToMyProfile() {
        if (currentUserId) {
            window.location.href = `user_profile.html?id=${currentUserId}`;
        } else {
            window.location.href = "login.html";
        }
    }

    // 1. è·å–æ•°æ® (åªè´Ÿè´£æ‹¿æ•°æ®)
    async function fetchFeed() {
        const container = document.getElementById("feedContainer");
        try {
            const res = await fetch('/api/tweets');
            globalTweets = await res.json(); // å­˜å…¥å…¨å±€å˜é‡
            renderFeed(); // æ‹¿å®Œæ•°æ®å»æ¸²æŸ“
        } catch(e) {
            console.error(e);
            container.innerHTML = `
                <div style="text-align:center; padding:40px; color:red;">
                    <span class="cn">åŠ è½½å¤±è´¥</span>
                    <span class="en">Load Failed</span>
                </div>`;
        }
    }

    // 2. æ¸²æŸ“ç•Œé¢ (è´Ÿè´£ç”Ÿæˆ HTML)
    function renderFeed() {
        const container = document.getElementById("feedContainer");
        const list = globalTweets;
        // è·å–å½“å‰è¯­è¨€ (localStorage é‡Œå¯èƒ½æ˜¯ zh æˆ– en)
        let currentLang = localStorage.getItem('appLang') || 'zh';
        if(currentLang === 'cn') currentLang = 'zh'; // å…¼å®¹æ—§æ•°æ®

        if(list.length === 0) {
            container.innerHTML = `
                <div style="text-align:center; padding:40px; color:#999;">
                    <span class="cn">æš‚æ— å†…å®¹ï¼Œå»å‘ä¸€æ¡å§ï¼</span>
                    <span class="en">No tweets yet, go publish one!</span>
                </div>
            `;
            // ä¸éœ€è¦å†è°ƒç”¨ applyLangï¼ŒCSS è‡ªåŠ¨ç”Ÿæ•ˆ
            return;
        }

        container.innerHTML = "";
        list.forEach(t => {
            const avatar = t.author.avatar ? `/uploads/${t.author.avatar}` : 'https://via.placeholder.com/48';
            const name = t.author.nickname || t.author.username;
            // é‡æ–°è®¡ç®—æ—¶é—´å­—ç¬¦ä¸² (æ ¹æ®å½“å‰è¯­è¨€)
            const timeStr = formatRelativeTime(t.createTime, currentLang);

            // é™„ä»¶æ˜¾ç¤ºé€»è¾‘ (ç”ŸæˆåŒè¯­æ ‡ç­¾)
            let fileHtml = "";
            if(t.originalFilename) {
                fileHtml = `
                    <div class="file-box" onclick="event.stopPropagation(); window.open('/uploads/${t.filePath.split(/[\\/]/).pop()}')">
                        <div class="file-icon"><i class="fas fa-file-alt"></i></div>
                        <div class="file-info">
                            <span class="file-label">
                                <span class="cn">é™„ä»¶æ–‡æ¡£</span>
                                <span class="en">Attachment</span>
                            </span>
                            <span class="file-name">${t.originalFilename}</span>
                        </div>
                    </div>
                `;
            }

            // æ ‡ç­¾æ˜¾ç¤ºé€»è¾‘ (æ”¯æŒç¿»è¯‘)
            let tagsHtml = "";
            if(t.tags) {
                const tagsArr = t.tags.split(',');
                tagsHtml = tagsArr.map(tag => {
                    // å¦‚æœæ˜¯è‹±æ–‡æ¨¡å¼ï¼Œå°è¯•ç¿»è¯‘ï¼Œå¦åˆ™æ˜¾ç¤ºåŸæ ·
                    const displayTag = currentLang === 'en' ? (tagTranslations[tag] || tag) : tag;
                    return `
                        <span class="tag-badge">
                            <i class="fas fa-tag"></i> ${displayTag}
                        </span>
                    `;
                }).join(" ");
            } else if (t.originalFilename && t.originalFilename.toLowerCase().endsWith(".pdf")) {
                tagsHtml = `<span class="tag-badge" style="background:#e6fffa; color:#00b894;">
                    <i class="fas fa-robot"></i>
                    <span class="cn">AI åˆ†æå°±ç»ª</span><span class="en">AI Analysis Ready</span>
                </span>`;
            }

            // ç”Ÿæˆå¡ç‰‡ HTML (æ³¨æ„ï¼šè¯„è®ºå’ŒæŸ¥çœ‹è¯¦æƒ…æŒ‰é’®ç°åœ¨éƒ½åŒ…å«äº† .cn å’Œ .en)
            container.innerHTML += `
                <div class="tweet-card" onclick="location.href='detail.html?id=${t.id}'">
                    <div class="card-header">
                        <div class="author-box" onclick="event.stopPropagation(); location.href='user_profile.html?id=${t.author.id}'">
                            <img src="${avatar}" class="author-avatar">
                            <div>
                                <div class="author-name">${name}</div>
                                <div class="author-handle">@${t.author.username}</div>
                            </div>
                        </div>
                        <div class="time-label">${timeStr}</div>
                    </div>

                    <div class="card-content">${t.content}</div>

                    ${fileHtml}
                    <div style="margin-top:5px;">${tagsHtml}</div>

                    <div class="card-footer">
                        <div class="action-item">
                            <i class="far fa-heart"></i>
                            <span>0</span>
                        </div>
                        <div class="action-item">
                            <i class="far fa-comment"></i>
                            <span class="cn">è¯„è®º</span><span class="en">Comment</span>
                        </div>
                    </div>
                </div>
            `;
        });
    }

    function formatRelativeTime(timestamp, lang) {
        const now = new Date();
        const postTime = new Date(timestamp);
        const diff = now - postTime;
        const seconds = Math.floor(diff / 1000);
        const minutes = Math.floor(seconds / 60);
        const hours = Math.floor(minutes / 60);
        const days = Math.floor(hours / 24);

        if(lang === 'zh' || lang === 'cn') { // å…¼å®¹
            if(seconds < 60) return "åˆšåˆš";
            if(minutes < 60) return `${minutes}åˆ†é’Ÿå‰`;
            if(hours < 24) return `${hours}å°æ—¶å‰`;
            return `${days}å¤©å‰`;
        } else {
            if(seconds < 60) return "Just now";
            if(minutes < 60) return `${minutes}m ago`;
            if(hours < 24) return `${hours}h ago`;
            return `${days}d ago`;
        }
    }

    function logout() {
        const lang = localStorage.getItem('appLang') || 'zh';
        // ç¡®è®¤æ¡†çš„æ–‡å­—åªèƒ½æ˜¯çº¯æ–‡æœ¬ï¼Œéœ€è¦ JS åˆ¤æ–­
        const msg = (lang === 'zh' || lang === 'cn') ? 'ç¡®å®šè¦é€€å‡ºå—ï¼Ÿ' : 'Are you sure to logout?';
        if(confirm(msg)) {
            localStorage.clear();
            window.location.href = "login.html";
        }
    }
</script>
</body>
</html>