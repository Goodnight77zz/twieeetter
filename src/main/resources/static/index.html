<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>
        <span class="cn">å¹¿åœº - Twieeetter</span>
        <span class="en">Plaza - Twieeetter</span>
    </title>
    <!-- å¼•å…¥é€šç”¨è¯­è¨€ç»„ä»¶CSS -->
    <link rel="stylesheet" href="common/lang-component.css">
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background-color: #f0f2f5; margin: 0; padding-top: 60px; }
        .navbar {   position: fixed; top: 0; width: 100%; background: white; height: 60px;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 25px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); z-index: 1000;
            box-sizing: border-box; }
        .nav-left { display: flex; align-items: center; gap: 20px; }
        .brand { color: #1da1f2; font-weight: 900; font-size: 24px; text-decoration: none; }

        /* === è·³è½¬æŒ‰é’® === */
        .nav-publish-btn {
            background-color: #1da1f2; color: white; border: none;
            padding: 8px 20px; border-radius: 20px; text-decoration: none;
            font-weight: bold; font-size: 14px;
            box-shadow: 0 2px 5px rgba(29, 161, 242, 0.3);
            transition: background 0.2s; display: flex; align-items: center; gap: 5px;
        }
        .nav-publish-btn:hover { background-color: #0d8ddb; }

        .nav-links { display: flex; align-items: center; gap: 20px;  flex-shrink: 0;}
        .nav-item { text-decoration: none; color: #555; font-weight: bold; font-size: 15px;
            white-space: nowrap; }
        .nav-item:hover { color: #1da1f2; }
        .logout-btn { color: #dc3545; cursor: pointer; text-decoration: none;
            font-weight: bold; border: 1px solid #dc3545;
            padding: 5px 18px;
            border-radius: 5px;
            font-size: 14px;
            transition: all 0.2s; }
        .logout-btn:hover { background-color: #dc3545; color: white; }

        .container { max-width: 600px; margin: 0 auto; padding: 20px; }

        /* æ¨æ–‡åˆ—è¡¨æ ·å¼ */
        .tweet { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #e1e8ed; }
        .tweet-header { display: flex; align-items: flex-start; margin-bottom: 12px; }
        .avatar-img { width: 48px; height: 48px; border-radius: 50%; margin-right: 12px; object-fit: cover; border: 1px solid #eee; }
        .author-info { display: flex; flex-direction: column; }
        .nickname { font-weight: bold; color: #0f1419; font-size: 16px; }
        .username { color: #536471; font-size: 14px; margin-top: 2px; }
        .time { margin-left: auto; color: #536471; font-size: 13px; }
        .content { font-size: 16px; line-height: 1.6; color: #0f1419; white-space: pre-wrap; margin-left: 60px; }
        .attachment-card { margin-top: 15px; margin-left: 60px; background-color: #f7f9f9; border: 1px solid #cfd9de; border-radius: 10px; padding: 12px 15px; display: flex; align-items: center; color: #536471; }
        .file-icon { font-size: 24px; margin-right: 12px; }
        .file-name { font-weight: bold; color: #1da1f2; font-size: 14px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 350px;}
    </style>
</head>
<body>

<div class="navbar">
    <div class="nav-left">
        <a href="index.html" class="brand">Twieeetter ğŸ“</a>
        <a href="dashboard.html" class="nav-publish-btn">
            <span>âš¡</span>
            <span class="cn">è¿›å…¥åˆ›ä½œä¸­å¿ƒ</span>
            <span class="en">Enter Creator Center</span>
        </a>
    </div>

    <div class="nav-links">
        <a href="search.html" class="nav-item">ğŸ”
            <span class="cn">æ‰¾æœ‹å‹</span>
            <span class="en">Find Friends</span>
        </a>
        <a href="friends.html" class="nav-item">ğŸ‘¥
            <span class="cn">å¥½å‹åˆ—è¡¨</span>
            <span class="en">Friends List</span>
        </a>
        <a href="profile.html" class="nav-item">ğŸ‘¤
            <span id="currentUser">
                <span class="cn">æˆ‘çš„ä¸»é¡µ</span>
                <span class="en">My Profile</span>
            </span>
        </a>
        <a class="logout-btn" onclick="logout()">
            <span class="cn">é€€å‡º</span>
            <span class="en">Logout</span>
        </a>
    </div>
</div>

<div class="container">
    <div id="feed">
        <div style="text-align:center; color:#999; margin-top: 50px;">
            <span class="cn">æ­£åœ¨åŠ è½½æœ€æ–°çš„ç ”ç©¶...</span>
            <span class="en">Loading latest research...</span>
        </div>
    </div>
</div>

<!-- é€šç”¨è¯­è¨€åˆ‡æ¢ç»„ä»¶HTML -->
<div class="lang-selector" id="langSelector">
    <button class="lang-trigger" id="langTrigger">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 21l5.25-11.25L21 21m-9-3h7.5M3 10.5h7.5M13.5 3H3v7.5" />
        </svg>
    </button>
    <div class="lang-dropdown">
        <button class="lang-option" id="langCn" onclick="switchLang('cn')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
            </svg>
            ä¸­æ–‡
        </button>
        <button class="lang-option" id="langEn" onclick="switchLang('en')">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
            </svg>
            English
        </button>
    </div>
</div>

<!-- å¼•å…¥é€šç”¨è¯­è¨€ç»„ä»¶JS -->
<script src="common/lang-component.js"></script>

<script>
    const userId = localStorage.getItem("userId");
    // å½“å‰è¯­è¨€çŠ¶æ€
    let currentLang = localStorage.getItem('appLang') || 'cn';

    if (!userId) {
        window.location.href = "login.html";
    } else {
        initUser(); // åˆå§‹åŒ–ç”¨æˆ·ä¿¡æ¯
        loadTweets();
    }

    // ç›‘å¬è¯­è¨€åˆ‡æ¢äº‹ä»¶ï¼Œæ›´æ–°é¡µé¢æ–‡æœ¬
    window.addEventListener('languageChange', function() {
        currentLang = localStorage.getItem('appLang') || 'cn';
        // åˆ·æ–°æ¨æ–‡åˆ—è¡¨å’Œç›¸å…³æ–‡æœ¬
        loadTweets();
        updateNavText();
    });

    // æ›´æ–°å¯¼èˆªæ é™æ€æ–‡æœ¬ï¼ˆè¯­è¨€åˆ‡æ¢æ—¶è°ƒç”¨ï¼‰
    function updateNavText() {
        const publishBtn = document.querySelector('.nav-publish-btn');
        publishBtn.innerHTML = `
            <span>âš¡</span>
            <span class="cn">è¿›å…¥åˆ›ä½œä¸­å¿ƒ</span>
            <span class="en">Enter Creator Center</span>
        `;

        const findFriendsLink = document.querySelectorAll('.nav-item')[0];
        findFriendsLink.innerHTML = `
            ğŸ”
            <span class="cn">æ‰¾æœ‹å‹</span>
            <span class="en">Find Friends</span>
        `;

        const friendsListLink = document.querySelectorAll('.nav-item')[1];
        friendsListLink.innerHTML = `
            ğŸ‘¥
            <span class="cn">å¥½å‹åˆ—è¡¨</span>
            <span class="en">Friends List</span>
        `;

        const logoutBtn = document.querySelector('.logout-btn');
        logoutBtn.innerHTML = `
            <span class="cn">é€€å‡º</span>
            <span class="en">Logout</span>
        `;
    }

    // æ–°å¢ï¼šè·å–ç”¨æˆ·è¯¦æƒ…æ¥æ˜¾ç¤ºæ˜µç§°
    async function initUser() {
        try {
            const res = await fetch(`/api/users/${userId}`);
            const user = await res.json();
            // ä¼˜å…ˆæ˜¾ç¤ºæ˜µç§°ï¼Œæ²¡æœ‰åˆ™æ˜¾ç¤ºç”¨æˆ·åï¼ˆä¿æŒåŸé€»è¾‘ï¼Œä¸å½±å“è¯­è¨€åˆ‡æ¢ï¼‰
            const userName = user.nickname || user.username;
            document.getElementById("currentUser").innerText = userName;
        } catch (e) {
            console.error(currentLang === 'cn' ? "è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥" : "Failed to get user info", e);
            // é™çº§æ–¹æ¡ˆï¼šæ˜¾ç¤º localStorage é‡Œçš„ç¼“å­˜
            const cachedName = localStorage.getItem("username") || (currentLang === 'cn' ? "æˆ‘çš„ä¸»é¡µ" : "My Profile");
            document.getElementById("currentUser").innerText = cachedName;
        }
    }

    async function loadTweets() {
        try {
            const response = await fetch('/api/tweets');
            if (!response.ok) throw new Error(currentLang === 'cn' ? "åŠ è½½å¤±è´¥" : "Loading failed");
            const tweets = await response.json();
            const feedDiv = document.getElementById("feed");
            feedDiv.innerHTML = "";

            const noContentText = currentLang === 'cn' ? 'æš‚æ—¶è¿˜æ²¡æœ‰å†…å®¹ï¼Œå¿«å»åˆ›ä½œä¸­å¿ƒå‘å¸ƒç¬¬ä¸€æ¡å§ï¼' : 'No content yet, go to Creator Center to publish your first research!';
            const attachmentText = currentLang === 'cn' ? 'é™„ä»¶æ–‡æ¡£' : 'Attachment Document';

            if (tweets.length === 0) {
                feedDiv.innerHTML = `<div style="text-align:center; color:#999; margin-top:50px;"><span class="cn">${noContentText}</span><span class="en">${noContentText}</span></div>`;
                return;
            }

            tweets.forEach(tweet => {
                const timeStr = tweet.createTime ? tweet.createTime.replace('T', ' ').split('.')[0] : (currentLang === 'cn' ? 'åˆšåˆš' : 'Just now');
                const nickname = tweet.author.nickname || tweet.author.username;
                const username = tweet.author.username;
                const avatarUrl = tweet.author && tweet.author.avatar ? '/uploads/' + tweet.author.avatar : 'https://via.placeholder.com/50';
                const fileName = tweet.originalFilename || null;

                let attachmentHtml = '';
                if (fileName) {
                    attachmentHtml = `
                        <div class="attachment-card">
                            <span class="file-icon">ğŸ“„</span>
                            <div>
                                <span style="font-size:12px;display:block;">${attachmentText}</span>
                                <span class="file-name">${fileName}</span>
                            </div>
                        </div>`;
                }

                const html = `
    <div class="tweet">
        <div class="tweet-header">
            <!-- ç»™å¤´åƒåŠ é“¾æ¥ -->
            <img src="${avatarUrl}" class="avatar-img"
                 onclick="location.href='user_profile.html?id=${tweet.author.id}'"
                 style="cursor:pointer">

            <div class="author-info">
                <!-- ç»™åå­—åŠ é“¾æ¥ -->
                <span class="nickname"
                      onclick="location.href='user_profile.html?id=${tweet.author.id}'"
                      style="cursor:pointer">${nickname}</span>
                <span class="username">@${username}</span>
            </div>
            <span class="time">${timeStr}</span>
        </div>
        <!-- ... ä¸‹é¢å†…å®¹ä¿æŒä¸å˜ ... -->
        <div class="content" onclick="location.href='detail.html?id=${tweet.id}'" style="cursor:pointer">${tweet.content}</div>
        ${attachmentHtml}
    </div>
`;
                feedDiv.innerHTML += html;
            });
        } catch (e) {
            console.error(e);
            const errorText = currentLang === 'cn' ? 'åŠ è½½å†…å®¹å¤±è´¥ï¼Œè¯·é‡è¯•' : 'Failed to load content, please try again';
            document.getElementById("feed").innerHTML = `<div style="text-align:center; color:red; margin-top:50px;">${errorText}</div>`;
        }
    }

    function logout() {
        const confirmText = currentLang === 'cn' ? 'ç¡®å®šè¦é€€å‡ºå—ï¼Ÿ' : 'Are you sure you want to logout?';
        if(confirm(confirmText)) {
            localStorage.clear();
            window.location.href = "login.html";
        }
    }
</script>
</body>
</html>