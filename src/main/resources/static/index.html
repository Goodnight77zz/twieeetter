<!DOCTYPE html>
<!-- é»˜è®¤è®¾ç½® lang="zh"ï¼ŒCSS ä¼šæ ¹æ®è¿™ä¸ªå±æ€§è‡ªåŠ¨æ§åˆ¶æ˜¾éš -->
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        <span class="cn">Twieeetter - å­¦æœ¯äº¤æµå¹³å°</span>
        <span class="en">Twieeetter - Academic Plaza</span>
    </title>
    <!-- å¼•å…¥é€šç”¨è¯­è¨€ç»„ä»¶CSS -->
    <link rel="stylesheet" href="common/lang-component.css">
    <!-- å¼•å…¥å›¾æ ‡åº“ -->
    <link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; background-color: #f0f2f5; margin: 0; padding-top: 70px; }

        /* é¡¶éƒ¨å¯¼èˆªæ  */
        .navbar {
            position: fixed; top: 0; width: 100%; background: white; height: 64px;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.08); z-index: 1000; box-sizing: border-box;
        }

        .nav-left { display: flex; align-items: center; gap: 20px; }
        .brand { font-size: 24px; font-weight: 900; color: #1da1f2; text-decoration: none; display: flex; align-items: center; gap: 5px; }

        /* åˆ›ä½œä¸­å¿ƒæŒ‰é’® */
        .btn-create {
            background: linear-gradient(90deg, #00a1d6, #00b5e5);
            color: white; padding: 8px 20px; border-radius: 20px;
            text-decoration: none; font-weight: bold; font-size: 14px;
            display: flex; align-items: center; gap: 5px; transition: transform 0.2s;
        }
        .btn-create:hover { transform: scale(1.05); }

        .nav-right { display: flex; align-items: center; gap: 25px; }

        /* å¯¼èˆªé“¾æ¥æ ·å¼ */
        .nav-item {
            text-decoration: none; color: #555; font-weight: 600; font-size: 15px;
            display: flex; align-items: center; gap: 6px; transition: color 0.2s;
        }
        .nav-item:hover { color: #1da1f2; }

        /* ç”¨æˆ·ä¿¡æ¯ */
        .user-info { display: flex; align-items: center; gap: 8px; cursor: pointer; }
        .avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 1px solid #eee; }
        .username { font-weight: bold; color: #333; }

        /* é€€å‡ºæŒ‰é’® */
        .btn-logout {
            border: 1px solid #ff4d4f; color: #ff4d4f; background: white;
            padding: 5px 15px; border-radius: 4px; cursor: pointer; font-size: 13px;
            transition: all 0.2s;
        }
        .btn-logout:hover { background: #fff1f0; }

        /* ä¸»å†…å®¹åŒº */
        .container { max-width: 700px; margin: 20px auto; padding-bottom: 40px; }

        /* æ¨æ–‡å¡ç‰‡ */
        .tweet-card {
            background: white; border-radius: 12px; padding: 20px;
            margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: transform 0.2s; cursor: pointer; position: relative;
        }
        .tweet-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }

        .card-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .author-box { display: flex; gap: 12px; }
        .author-avatar { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; }
        .author-name { font-weight: bold; font-size: 16px; color: #0f1419; }
        .author-handle { color: #536471; font-size: 14px; }
        .time-label { color: #536471; font-size: 13px; }

        .card-content { font-size: 16px; line-height: 1.6; color: #0f1419; margin-bottom: 15px; white-space: pre-wrap; }

        /* é™„ä»¶å±•ç¤º */
        .file-box {
            background: #f7f9f9; border: 1px solid #cfd9de; border-radius: 12px;
            padding: 12px; display: flex; align-items: center; gap: 12px; margin-top: 10px;
        }
        .file-icon { font-size: 24px; color: #536471; background: #eff3f4; padding: 8px; border-radius: 8px; }
        .file-info { display: flex; flex-direction: column; overflow: hidden; }
        .file-name { font-weight: bold; color: #1da1f2; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .file-label { font-size: 12px; color: #536471; }

        /* åº•éƒ¨æ“ä½œæ  */
        .card-footer { display: flex; gap: 20px; margin-top: 15px; border-top: 1px solid #eff3f4; padding-top: 10px; color: #536471; font-size: 14px; }
        .action-item { display: flex; align-items: center; gap: 5px; cursor: pointer; transition: color 0.2s; }
        .action-item:hover { color: #1da1f2; }
        .like-num { font-weight: bold; }

        /* æ ‡ç­¾æ ·å¼ */
        .tag-badge {
            display: inline-block; padding: 2px 8px; border-radius: 12px;
            background: #e8f5fe; color: #1da1f2; font-size: 12px; margin-top: 8px; margin-right: 5px;
        }

        /* æ‰‹æœºç«¯é€‚é… */
        @media (max-width: 600px) {
            .nav-item span { display: none; } /* æ‰‹æœºç«¯éšè—å¯¼èˆªæ–‡å­—åªç•™å›¾æ ‡ */
            .btn-create span { display: none; }
            .navbar { padding: 0 10px; }
        }
    </style>
</head>
<body>

<!-- é¡¶éƒ¨å¯¼èˆªæ  -->
<div class="navbar">
    <div class="nav-left">
        <a href="index.html" class="brand">
            Twieeetter ğŸ“
        </a>
        <a href="dashboard.html" class="btn-create">
            <i class="fas fa-bolt"></i>
            <span class="cn">è¿›å…¥åˆ›ä½œä¸­å¿ƒ</span>
            <span class="en">Creator Center</span>
        </a>
    </div>

    <div class="nav-right">
        <a href="search.html" class="nav-item">
            <i class="fas fa-search"></i>
            <span class="cn">æœç´¢</span>
            <span class="en">Search</span>
        </a>

        <a href="friends.html" class="nav-item">
            <i class="fas fa-users"></i>
            <span class="cn">å¥½å‹åˆ—è¡¨</span>
            <span class="en">Friends</span>
        </a>

        <!-- ç”¨æˆ·ä¿¡æ¯ -->
        <div class="user-info" onclick="goToMyProfile()">
            <img id="navAvatar" src="https://via.placeholder.com/32" class="avatar">
            <span id="navUsername" class="username">User</span>
        </div>

        <button onclick="logout()" class="btn-logout">
            <span class="cn">é€€å‡º</span>
            <span class="en">Logout</span>
        </button>
    </div>
</div>

<!-- ä¸»å†…å®¹ï¼šæ¨æ–‡æµ -->
<div class="container" id="feedContainer">
    <div style="text-align: center; padding: 40px; color: #999;">
        <span class="cn">åŠ è½½ä¸­...</span>
        <span class="en">Loading...</span>
    </div>
</div>

<!-- è¯­è¨€åˆ‡æ¢æ‚¬æµ®çƒ -->
<div class="lang-selector" id="langSelector">
    <button class="lang-trigger" id="langTrigger">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 21l5.25-11.25L21 21m-9-3h7.5M3 10.5h7.5M13.5 3H3v7.5" />
        </svg>
    </button>
    <div class="lang-dropdown">
        <button class="lang-option" onclick="switchLang('zh')">ä¸­æ–‡</button>
        <button class="lang-option" onclick="switchLang('en')">English</button>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="common/lang-component.js"></script>

<script>
    // æ ‡ç­¾ç¿»è¯‘å­—å…¸
    const tagTranslations = {
        "AI": "AI",
        "ç”Ÿç‰©åŒ»å­¦": "Biomedical",
        "è®¡ç®—æœº": "Comp Sci",
        "ç‰©ç†": "Physics",
        "åŒ–å­¦": "Chemistry",
        "æ·±åº¦å­¦ä¹ ": "Deep Learning",
        "æ•°æ®åˆ†æ": "Data Analysis"
    };

    const currentUserId = localStorage.getItem("userId");
    if(!currentUserId) window.location.href = "login.html";

    // å…¨å±€å˜é‡ç¼“å­˜æ•°æ®
    let globalTweets = [];

    // åˆå§‹åŒ–
    loadUserInfo();
    fetchFeed();

    // ç›‘å¬è¯­è¨€åˆ‡æ¢
    window.addEventListener('languageChange', function() {
        renderFeed();
    });

    async function loadUserInfo() {
        const username = localStorage.getItem("username");
        document.getElementById("navUsername").innerText = username;
        try {
            const res = await fetch(`/api/users/${currentUserId}`);
            const user = await res.json();
            if(user.avatar) {
                document.getElementById("navAvatar").src = "/uploads/" + user.avatar;
            }
        } catch(e) {}
    }

    function goToMyProfile() {
        if (currentUserId) {
            window.location.href = `user_profile.html?id=${currentUserId}`;
        } else {
            window.location.href = "login.html";
        }
    }

    // 1. è·å–æ•°æ® (å¹¶è¡Œè·å–ç‚¹èµçŠ¶æ€)
    async function fetchFeed() {
        const container = document.getElementById("feedContainer");
        try {
            // 1. å…ˆæ‹¿æ¨æ–‡åˆ—è¡¨
            const res = await fetch('/api/tweets');
            globalTweets = await res.json();

            // 2. ğŸ”¥ å…³é”®ä¿®å¤ï¼šå¹¶è¡Œè·å–æ¯ä¸€æ¡çš„ç‚¹èµæ•°å’ŒçŠ¶æ€
            // å› ä¸ºåç«¯åˆ—è¡¨æ¥å£æ²¡è¿”å› likeCountï¼Œå‰ç«¯æ‰‹åŠ¨è¡¥å…¨
            if (globalTweets.length > 0) {
                const promises = globalTweets.map(async (tweet) => {
                    try {
                        const likeRes = await fetch(`/api/tweets/${tweet.id}/like-status?userId=${currentUserId}`);
                        const likeData = await likeRes.json();
                        tweet.likeCount = likeData.count; // è¡¥å…¨æ•°æ®
                        tweet.isLiked = likeData.isLiked; // è¡¥å…¨æ•°æ®
                    } catch (e) {
                        tweet.likeCount = 0;
                        tweet.isLiked = false;
                    }
                });
                await Promise.all(promises); // ç­‰æ‰€æœ‰ç‚¹èµæ•°æ®åŠ è½½å®Œå†æ¸²æŸ“
            }

            renderFeed();
        } catch(e) {
            console.error(e);
            container.innerHTML = `<div style="text-align:center; padding:40px; color:red;">Load Failed</div>`;
        }
    }

    // 2. æ¸²æŸ“ç•Œé¢
    function renderFeed() {
        const container = document.getElementById("feedContainer");
        const list = globalTweets;
        const currentLang = localStorage.getItem('appLang') || 'zh';

        if(list.length === 0) {
            container.innerHTML = `
                <div style="text-align:center; padding:40px; color:#999;">
                    <span class="cn">æš‚æ— å†…å®¹ï¼Œå»å‘ä¸€æ¡å§ï¼</span>
                    <span class="en">No tweets yet, go publish one!</span>
                </div>
            `;
            return;
        }

        container.innerHTML = "";
        list.forEach(t => {
            const avatar = t.author.avatar ? `/uploads/${t.author.avatar}` : 'https://via.placeholder.com/48';
            const name = t.author.nickname || t.author.username;
            const timeStr = formatRelativeTime(t.createTime, currentLang);

            let fileHtml = "";
            if(t.originalFilename) {
                fileHtml = `
                    <div class="file-box" onclick="event.stopPropagation(); window.open('/uploads/${t.filePath.split(/[\\/]/).pop()}')">
                        <div class="file-icon"><i class="fas fa-file-alt"></i></div>
                        <div class="file-info">
                            <span class="file-label">
                                <span class="cn">é™„ä»¶æ–‡æ¡£</span>
                                <span class="en">Attachment</span>
                            </span>
                            <span class="file-name">${t.originalFilename}</span>
                        </div>
                    </div>
                `;
            }

            let tagsHtml = "";
            if(t.tags) {
                const tagsArr = t.tags.split(',');
                tagsHtml = tagsArr.map(tag => {
                    const displayTag = currentLang === 'en' ? (tagTranslations[tag] || tag) : tag;
                    return `<span class="tag-badge" style="background:#e8f5fe; color:#1da1f2;">#${displayTag}</span>`;
                }).join(" ");
            } else if (t.originalFilename && t.originalFilename.toLowerCase().endsWith(".pdf")) {
                tagsHtml = `<span class="tag-badge" style="background:#e6fffa; color:#00b894;">
                    <i class="fas fa-robot"></i>
                    <span class="cn">AI åˆ†æå°±ç»ª</span><span class="en">AI Analysis Ready</span>
                </span>`;
            }

            // â¤ï¸ ç‚¹èµçŠ¶æ€é€»è¾‘
            const heartClass = t.isLiked ? "fas fa-heart" : "far fa-heart";
            const heartColor = t.isLiked ? "color: #f91880;" : "";

            container.innerHTML += `
                <div class="tweet-card" onclick="location.href='detail.html?id=${t.id}'">
                    <div class="card-header">
                        <div class="author-box" onclick="event.stopPropagation(); location.href='user_profile.html?id=${t.author.id}'">
                            <img src="${avatar}" class="author-avatar">
                            <div>
                                <div class="author-name">${name}</div>
                                <div class="author-handle">@${t.author.username}</div>
                            </div>
                        </div>
                        <div class="time-label">${timeStr}</div>
                    </div>

                    <div class="card-content">${t.content}</div>

                    ${fileHtml}
                    <div style="margin-top:5px;">${tagsHtml}</div>

                    <div class="card-footer">
                        <!-- ğŸ”¥ ä¿®å¤ï¼šç»‘å®šäº†ç‚¹å‡»äº‹ä»¶ toggleLikeInList -->
                        <div class="action-item" onclick="event.stopPropagation(); toggleLikeInList(this, ${t.id})">
                            <i class="${heartClass}" style="${heartColor}"></i>
                            <span class="like-num" style="margin-left:5px;">${t.likeCount || 0}</span>
                        </div>
                        <!-- ğŸ”¥ ä¿®å¤ï¼šç»‘å®šç‚¹å‡»è·³è½¬åˆ°è¯¦æƒ…é¡µè¯„è®ºåŒº -->
                        <div class="action-item" onclick="event.stopPropagation(); location.href='detail.html?id=${t.id}#commentSection'">
                            <i class="far fa-comment"></i>
                            <span style="margin-left:5px;">
                                <span class="cn">è¯„è®º</span><span class="en">Comment</span>
                            </span>
                        </div>
                    </div>
                </div>
            `;
        });
    }

    // ğŸ”¥ æ ¸å¿ƒä¿®å¤ï¼šåˆ—è¡¨é¡µç›´æ¥ç‚¹èµ (ä¹è§‚æ›´æ–°)
    async function toggleLikeInList(btn, tweetId) {
        const icon = btn.querySelector('i');
        const numSpan = btn.querySelector('.like-num');
        let currentNum = parseInt(numSpan.innerText);

        // 1. ç«‹å³æ”¹å˜ UI (è®©ç”¨æˆ·è§‰å¾—å¾ˆå¿«)
        if (icon.classList.contains('far')) {
            // ç‚¹èµ
            icon.className = 'fas fa-heart';
            icon.style.color = '#f91880';
            numSpan.innerText = currentNum + 1;
        } else {
            // å–æ¶ˆç‚¹èµ
            icon.className = 'far fa-heart';
            icon.style.color = '';
            numSpan.innerText = Math.max(0, currentNum - 1);
        }

        // 2. åå°å‘è¯·æ±‚
        try {
            await fetch(`/api/tweets/${tweetId}/like?userId=${currentUserId}`, { method: 'POST' });
            // æ›´æ–°å…¨å±€ç¼“å­˜é‡Œçš„çŠ¶æ€ï¼Œé˜²æ­¢åˆ‡è¯­è¨€æ—¶å˜å›å»
            const tweet = globalTweets.find(t => t.id == tweetId);
            if(tweet) {
                tweet.isLiked = !tweet.isLiked;
                tweet.likeCount = parseInt(numSpan.innerText);
            }
        } catch (e) {
            // å¤±è´¥å›æ»š
            alert("Network error");
            fetchFeed(); // é‡æ–°æ‹‰å–çœŸå®æ•°æ®
        }
    }

    function formatRelativeTime(timestamp, lang) {
        const now = new Date();
        const postTime = new Date(timestamp);
        const diff = now - postTime;
        const seconds = Math.floor(diff / 1000);
        const minutes = Math.floor(seconds / 60);
        const hours = Math.floor(minutes / 60);
        const days = Math.floor(hours / 24);

        if(lang === 'zh' || lang === 'cn') {
            if(seconds < 60) return "åˆšåˆš";
            if(minutes < 60) return `${minutes}åˆ†é’Ÿå‰`;
            if(hours < 24) return `${hours}å°æ—¶å‰`;
            return `${days}å¤©å‰`;
        } else {
            if(seconds < 60) return "Just now";
            if(minutes < 60) return `${minutes}m ago`;
            if(hours < 24) return `${hours}h ago`;
            return `${days}d ago`;
        }
    }

    function logout() {
        const lang = localStorage.getItem('appLang') || 'zh';
        const msg = (lang === 'zh' || lang === 'cn') ? 'ç¡®å®šè¦é€€å‡ºå—ï¼Ÿ' : 'Are you sure to logout?';
        if(confirm(msg)) {
            localStorage.clear();
            window.location.href = "login.html";
        }
    }
</script>
</body>
</html>